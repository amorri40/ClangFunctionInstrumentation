timeglider=window.timeglider||{mode:"publish",version:"0.1.0",ui:{touchtesting:false}};timeglider.TG_Date={};
(function(t){function A(c){return parseInt(c,10)}function x(c){var g=parseInt(c,10);return g>9||g<0?String(c):"0"+g}t=timeglider;var h=jQuery,v={},w={},n={},d={},i={},a=/^(\-?\d+)?(\-\d{1,2})?(\-\d{1,2})?(?:T| )?(\d{1,2})?(?::)?(\d{1,2})?(?::)?(\d{1,2})?(\+|\-)?(\d{1,2})?(?::)?(\d{1,2})?/;t.TG_Date=function(c,g,l){var o,q,b;l=l||0;if(typeof c=="number"){o=q=k.getDateFromSec(c);b=c+l}else if(typeof c!=="object"){if(c=="today")c=k.getToday();o=q=c}if(a.test(o)){c=k.parse8601(o);if(c.tz_ho)c=k.toFromUTC(c,
{hours:c.tz_ho,minutes:c.tz_mi},"to");h.extend(this,c);this.rd=k.getRataDie(this);this.mo_num=this.ye>0?(this.ye-1)*12+this.mo:-1*((Math.abs(this.ye)-1)*12+(12-(this.mo-1)));this.sec=b||(this.rd>0?1:-1)*(Math.abs(this.rd)*86400+this.ho*3600+(this.mi-1)*60);this.date_display=g?g.toLowerCase().substr(0,2):"da";this.dateStr=q}else return{error:"invalid date"};return this};var k=t.TG_Date;k.getTimeUnitSerial=function(c,g){var l=0,o;o=c.ye<0?Math.ceil:Math.floor;switch(g){case "da":l=c.rd;break;case "mo":l=
c.mo_num;break;case "ye":l=c.ye;break;case "de":l=o(c.ye/10);break;case "ce":l=o(c.ye/100);break;case "thou":l=o(c.ye/1E3);break;case "tenthou":l=o(c.ye/1E4);break;case "hundredthou":l=o(c.ye/1E5);break;case "mill":l=o(c.ye/1E6);break;case "tenmill":l=o(c.ye/1E7);break;case "hundredmill":l=o(c.ye/1E8);break;case "bill":l=o(c.ye/1E9)}return l};k.getMonthDays=function(c,g){return k.isLeapYear(g)==true&&c==2?29:k.monthsDayNums[c]};k.twentyFourToTwelve=function(c){var g={};g.ye=c.ye;g.mo=c.mo||1;g.da=
c.da||1;g.ho=c.ho||0;g.mi=c.mi||0;g.ampm="am";if(c.ho>=12){g.ampm="pm";g.ho=c.ho>12?c.ho-12:12}else if(c.ho==0){g.ho=12;g.ampm="am"}else g.ho=c.ho;if(g.mi<9)g.mi="0"+g.mi;return g};k.getMonthAdj=function(c,g){var l=k.getDateFromMonthNum(c);switch(l.mo){case 1:case 3:case 5:case 7:case 8:case 10:case 12:l=Math.floor(g+g/28*3);return{width:l,days:31};case 2:if(k.isLeapYear(l.ye)==true){l=Math.floor(g+g/28);return{width:l,days:29}}else return{width:g,days:28};default:l=Math.floor(g+g/28*2);return{width:l,
days:30}}};k.getDateFromMonthNum=function(c){var g=0;if(c>0){g=c%12;if(g==0)g=12;c=Math.ceil(c/12)}else{g=Math.abs(c)%12;g=12-g+1;if(g==13)g=1;c=-1*Math.ceil(Math.abs(c)/12)}return{ye:c,mo:g}};k.getMonthWidth=function(c,g,l){var o=l/28,q;switch(c){case 1:case 3:case 5:case 7:case 8:case 10:case 12:q=3;break;case 4:case 6:case 9:case 11:q=2;break;case 2:q=k.isLeapYear(g)==true?1:0}return{width:Math.floor(l+o*q),numDays:28+q}};k.getToday=function(){var c=new Date;return c.getUTCFullYear()+"-"+(c.getUTCMonth()+
1)+"-"+c.getUTCDate()+" "+c.getUTCHours()+":"+c.getUTCMinutes()+":"+c.getUTCSeconds()};k.getMonthFromRemDays=function(c,g){var l=0;var o=l=0;l=k.isLeapYear(g)?1:0;if(c<=31){o=1;l=c}else if(c>31&&c<=59+l){o=2;l=c-(31+l)}else if(c>59+l&&c<=90+l){o=3;l=c-(59+l)}else if(c>90+l&&c<=120+l){o=4;l=c-(90+l)}else if(c>120+l&&c<=151+l){o=5;l=c-(120+l)}else if(c>151+l&&c<=181+l){o=6;l=c-(151+l)}else if(c>181+l&&c<=212+l){o=7;l=c-(181+l)}else if(c>212+l&&c<=243+l){o=8;l=c-(212+l)}else if(c>243+l&&c<=273+l){o=
9;l=c-(243+l)}else if(c>273+l&&c<=304+l){o=10;l=c-(273+l)}else if(c>304+l&&c<=334+l){o=11;l=c-(304+l)}else{o=12;l=c-(334+l)}return{mo:o,da:l}};k.getDateFromRD=function(c){if(d[c])return d[c];for(var g=Math.floor(c),l=Math.floor(g/146097)*400,o=g-Math.floor(g/146097)*146097,q=1,b=l+1,e=b+400;b<=e;b++)if(o>365){o-=365;if(k.isLeapYear(b))o-=1;q++}else b=e;l+=q;if(o==0)o=1;o=k.getMonthFromRemDays(o,l);q=(c-g)*1440;g=Math.floor(q%60);q=Math.floor(q/60);if(k.isLeapYear(l)&&o.mo==2)o.da+=1;g=l+"-"+o.mo+
"-"+o.da+" "+q+":"+g+":00";return d[c]=g};k.getDateFromSec=function(c){if(i[c])return i[c];var g=k.getDateFromRD(c/86400);return i[c]=g};k.isLeapYear=function(c){return c%400==0?true:c%100==0?false:c%4==0?true:false};k.getRataDie=function(c){function g(m,j){if(w[m+"-"+j])return w[m+"-"+j];for(var p=0,s=m;s<j;s++)p+=k.isLeapYear(s)?366:365;return w[m+"-"+j]=p}function l(m,j){var p;switch(m){case 1:p=0;break;case 2:p=31;break;case 3:p=59;break;case 4:p=90;break;case 5:p=120;break;case 6:p=151;break;
case 7:p=181;break;case 8:p=212;break;case 9:p=243;break;case 10:p=273;break;case 11:p=304;break;case 12:p=334}if(m>2)if(k.isLeapYear(j))p+=1;return p}var o=c.ye,q=c.mo;c=c.da;var b=0;if(v[o+"-"+q+"-"+c])return v[o+"-"+q+"-"+c];if(o>=0){if(o==0)o=1;b=Math.floor(o/400)*146097;var e=parseInt(g(o-o%400,o)),f=parseInt(l(q,o));b=b+e+f+c-366}else if(o<0)b=k.getBCRataDie({ye:o,mo:q,da:c});return v[o+"-"+q+"-"+c]=b};k.monthNamesLet=["","J","F","M","A","M","J","J","A","S","O","N","D"];k.monthsDayNums=[0,31,
28,31,30,31,30,31,31,30,31,30,31,29];k.units=["da","mo","ye","de","ce","thou","tenthou","hundredthou","mill","tenmill","hundredmill","bill"];k.getBCRataDie=function(c){var g=c.ye,l=c.mo;c=c.da;if(n[g+"-"+l+"-"+c])return n[g+"-"+l+"-"+c];if(l==0)l=1;if(c==0)c=1;var o=-1*((Math.abs(g)-1)*366+[0,335,306,275,245,214,184,153,122,92,61,31,0][l]+(k.monthsDayNums[l]-c+1));return n[g+"-"+l+"-"+c]=o};k.setCulture=function(c){c=t.culture=Globalize.culture(c||"default");k.monthNames=h.merge([""],c.calendar.months.names);
k.monthNamesAbbr=h.merge([""],c.calendar.months.namesAbbr);k.dayNames=c.calendar.days.names;k.dayNamesAbbr=c.calendar.days.namesAbbr;k.dayNamesShort=c.calendar.days.namesShort;k.patterns=c.calendar.patterns};k.prototype={format:function(c,g,l){var o=l||{hours:0,minutes:0};l="da";if(g==true){l=this.date_display.substr(0,2);switch(l){case "no":return"";case "ye":c="yyyy";break;case "mo":c="MMM yyyy";break;case "da":c="MMM d, yyyy";break;case "ho":c="MMM d, yyyy h:mm tt";break;default:c="f"}}g=_.clone(this);
g=k.toFromUTC(g,o,"from");if(timeglider.i18n)return timeglider.i18n.formatDate(g,l);else if(g.ye<-27E4)return this.ye;else{l=new Date(g.ye,g.mo-1,g.da,g.ho,g.mi,g.se,0);return Globalize.format(l,c)}}};k.getTimeOffset=function(c){c=c.replace(/[^-\d:]/gi,"");var g=c.split(":"),l=parseInt(g[0],10);g=parseInt(g[1],10);var o=l+(l<0?-1:1)*(g/60);return{decimal:o,hours:l,minutes:g,seconds:o*3600,string:c}};k.tzOffsetStr=function(c,g){if(c){if(c.length==19)c+=g;else if(c.length==16)c+=":00"+g;return c}};
k.parse8601=function(c){var g,l,o,q,b,e,f,m;b=function(j){return j?parseInt(j.replace("-",""),10):0};m=c.match(a);c=parseInt(m[1]);if(!c)return{error:"invalid date; no year provided"};g=b(m[2])||1;l=b(m[3])||1;o=b(m[4])||0;q=b(m[5])||0;b=b(m[6])||0;e=m[7]||"+";f=parseInt(m[8],10)||0;if(e=="-")f*=-1;m=parseInt(m[9],10)||0;if(e=="-")m*=-1;return{ye:c,mo:g,da:l,ho:o,mi:q,se:b,tz_ho:f,tz_mi:m}};k.getLastDayOfMonth=function(c,g){var l=[0,31,28,31,30,31,30,31,31,30,31,30,31],o=0;return o=g==2&&k.isLeapYear(c)==
true?29:l[g]};k.getDateTimeStrings=function(c){var g=k.parse8601(c);if(c=="today"||c=="now")return{date:c,time:""};else c=g.ye+"-"+x(g.mo)+"-"+x(g.da);var l="pm";if(g.ho>=12){if(g.ho>12)g.ho-=12;l="pm"}else{if(g.ho==0)g.ho="12";l="am"}g=A(g.ho)+":"+x(g.mi)+" "+l;return{date:c,time:g}};k.transValidateDateString=function(c){if(c=="today"||c=="now")return c;if(!c)return false;var g=c.match(/^(\-?\d+|today|now) ?(bce?)?-?(\d{1,2})?-?(\d{1,2})?/);c=k.zeroButt;if(g){var l=g[1],o=g[2]||"",q=g[3]||"07";g=
g[4]||"1";if(parseInt(l,10)<0||o.substr(0,1)=="b")l=-1*Math.abs(l);return k.validateDate(l,q,g)?l+"-"+c(q)+"-"+c(g):false}else return false};k.transValidateTimeString=function(c){if(!c)return"12:00:00";c=c.toLowerCase().match(/^(\d{1,2}|noon):?(\d{1,2})?:?(\d{1,2})? ?(am|pm)?/i);var g="";g=k.zeroButt;if(c[1])if(c[0]=="noon")g="12:00:00";else{var l=parseInt(c[1],10)||12,o=parseInt(c[2],10)||0,q=parseInt(c[3],10)||0;c=c[4]||"am";if(k.validateTime(l,o,q)==false)return false;if(c=="pm"&&l<12)l+=12;else if(c==
"am"&&l==12)l=0;g=g(l)+":"+g(o)+":"+g(q)}else g=false;return g};k.validateTime=function(c,g,l){if(c<0||c>23||g<0||g>59||l<0||l>59)return false;return true};k.validateDate=function(c,g,l){var o=k.getMonthDays(g,c);if(l>o||l<=0)return false;if(g>12||g<0)return false;if(c==0)return false;return true};k.zeroButt=function(c){c=parseInt(c,10);return c>9?String(c):"0"+c};k.toFromUTC=function(c,g,l){var o=0,q=[0,31,28,31,30,31,30,31,31,30,31,30,31,29];o={};if(l=="from"){o.ho=-1*g.hours;o.mi=-1*g.minutes}else if(l==
"to"){o.ho=g.hours;o.mi=g.minutes}else{o.ho=-1*c.tz_ho;o.mi=-1*c.tz_mi}if(o.ho==0&&o.mi==0)return c;l=c.ho+c.mi/60+(-1*o.ho+o.mi*-1/60);if(l<0){o=24+l;if(c.da>1)c.da-=1;else if(c.mo==1){c.ye-=1;c.mo=12;c.da=31}else{c.mo-=1;c.da=k.getLastDayOfMonth(c.ye,c.mo)}}else if(l>=24){o=l-24;if(k.isLeapYear(c.ye)&&c.mo==2&&c.da==28)c.da=29;else if(c.da==q[c.mo]){if(c.mo==12){c.ye+=1;c.mo=1}else c.mo+=1;c.da=1}else c.da+=1}else o=l;q=function(b){b=Math.abs(b);var e=Math.floor(b);return{ho:e,mi:Math.round((b-
e)*60),se:0}}(o);c.ho=q.ho;c.mi=q.mi;if(g){c.tz_ho=g.tz_ho;c.tz_mi=g.tz_mi}else{c.tz_ho=0;c.tz_mi=0}return{ye:c.ye,mo:c.mo,da:c.da,ho:c.ho,mi:c.mi,se:c.se}};k.TGSecToUnixSec=function(c){return c-62135661873};k.JSDateToISODateString=function(c){var g=function(l){return l<10?"0"+l:l};return c.getUTCFullYear()+"-"+g(c.getUTCMonth()+1)+"-"+g(c.getUTCDate())+" "+g(c.getUTCHours())+":"+g(c.getUTCMinutes())+":"+g(c.getUTCSeconds())};k.timezones=[{offset:"-12:00",name:"Int'l Date Line West"},{offset:"-11:00",
name:"Bering & Nome"},{offset:"-10:00",name:"Alaska-Hawaii Standard Time"},{offset:"-10:00",name:"U.S. Hawaiian Standard Time"},{offset:"-10:00",name:"U.S. Central Alaska Time"},{offset:"-09:00",name:"U.S. Yukon Standard Time"},{offset:"-08:00",name:"U.S. Pacific Standard Time"},{offset:"-07:00",name:"U.S. Mountain Standard Time"},{offset:"-07:00",name:"U.S. Pacific Daylight Time"},{offset:"-06:00",name:"U.S. Central Standard Time"},{offset:"-06:00",name:"U.S. Mountain Daylight Time"},{offset:"-05:00",
name:"U.S. Eastern Standard Time"},{offset:"-05:00",name:"U.S. Central Daylight Time"},{offset:"-04:00",name:"U.S. Atlantic Standard Time"},{offset:"-04:00",name:"U.S. Eastern Daylight Time"},{offset:"-03:30",name:"Newfoundland Standard Time"},{offset:"-03:00",name:"Brazil Standard Time"},{offset:"-03:00",name:"Atlantic Daylight Time"},{offset:"-03:00",name:"Greenland Standard Time"},{offset:"-02:00",name:"Azores Time"},{offset:"-01:00",name:"West Africa Time"},{offset:"00:00",name:"Greenwich Mean Time/UTC"},
{offset:"00:00",name:"Western European Time"},{offset:"01:00",name:"Central European Time"},{offset:"01:00",name:"Middle European Time"},{offset:"01:00",name:"British Summer Time"},{offset:"01:00",name:"Middle European Winter Time"},{offset:"01:00",name:"Swedish Winter Time"},{offset:"01:00",name:"French Winter Time"},{offset:"02:00",name:"Eastean EU"},{offset:"02:00",name:"USSR-zone1"},{offset:"02:00",name:"Middle European Summer Time"},{offset:"02:00",name:"French Summer Time"},{offset:"03:00",
name:"Baghdad Time"},{offset:"03:00",name:"USSR-zone2"},{offset:"03:30",name:"Iran"},{offset:"04:00",name:"USSR-zone3"},{offset:"05:00",name:"USSR-zone4"},{offset:"05:30",name:"Indian Standard Time"},{offset:"06:00",name:"USSR-zone5"},{offset:"06:30",name:"North Sumatra Time"},{offset:"07:00",name:"USSR-zone6"},{offset:"07:00",name:"West Australian Standard Time"},{offset:"07:30",name:"Java"},{offset:"08:00",name:"China & Hong Kong"},{offset:"08:00",name:"USSR-zone7"},{offset:"08:00",name:"West Australian Daylight Time"},
{offset:"09:00",name:"Japan"},{offset:"09:00",name:"Korea"},{offset:"09:00",name:"USSR-zone8"},{offset:"09:30",name:"South Australian Standard Time"},{offset:"09:30",name:"Central Australian Standard Time"},{offset:"10:00",name:"Guam Standard Time"},{offset:"10:00",name:"USSR-zone9"},{offset:"10:00",name:"East Australian Standard Time"},{offset:"10:30",name:"Central Australian Daylight Time"},{offset:"10:30",name:"South Australian Daylight Time"},{offset:"11:00",name:"USSR-zone10"},{offset:"11:00",
name:"East Australian Daylight Time"},{offset:"12:00",name:"New Zealand Standard Time"},{offset:"12:00",name:"Int'l Date Line East"},{offset:"13:00",name:"New Zealand Daylight Time"}];k.boil=A;k.unboil=x})(timeglider);(function(t){var A=t.levelHeight=12;t.TG_Org=function(){var x=this,h=t.icon_folder;this.blocks=[];this.ids=[];this.vis=[];this.pol=-1;this.placedBlocks=[];this.freshBlocks=[];this.addBlock=function(d,i){d.right=d.left+d.width;d.bottom=d.top+d.height;d.tickScope=i;x.freshBlocks.push(d);x.blocks.push(d)};this.clearFresh=function(){x.freshBlocks=[]};this.getBorg=function(){return this};this.getBlocks=function(){return this.blocks};this.getHTML=function(d){var i=d.tickScope,a=d.ceiling;this.onIZoom=d.onIZoom;
if(i=="sweep")this.vis=[];this.pol=d.inverted?1:-1;this.freshBlocks.sort(v);var k,c,g="",l="";d="";var o=0,q={},b=this.freshBlocks.length;c="";var e=0;k=0;var f=g="",m="";e="";k="lane";k=m="";for(var j=0;j<b;j++){q=this.freshBlocks[j];e=0;m="";if(q.tickScope==i)if(_.indexOf(this.vis,q.id)==-1){this.vis.push(q.id);if(q.html&&q.html.substr(0,4)=="<div")d+="<div style='left:"+q.left+"px' id='"+q.id+"'"+q.html.substr(4);else{if(q.image){k=q.image.display_class;g=q.shape&&k=="inline"?" style='width:"+
q.shape.img_wi+"px;height:auto;top:-"+q.shape.img_ht+"px'":"";e=0;g="<div data-max_height='"+q.image.max_height+"' class='timeglider-event-image-"+k+"'><img src='"+q.image.src+"' "+g+"></div>"}else g="";k=a-30;if(this.onIZoom&&q.y_position>0)q.top=x.pol*q.y_position;else{q.attempts=0;n(q,k)}if(k=x.pol==-1?a&&Math.abs(q.top)>k:a&&Math.abs(q.top+30)>k){e=x.pol==-1?"top:-"+(a-10)+"px":"top:"+a+"px";m="<img src='"+h+"shapes/circle_white.png'>";m=q.icon?"<img src='"+h+q.icon+"'>":m;d+="<div id='"+q.id+
"' class='timeglider-timeline-event tg-event-overflow' style='left:"+q.left+"px;"+e+"'>"+m+"</div>"}else if(q.fontsize>2){c=q.span_color?";background-color:"+q.span_color:"";q.fontsize<10?q.opacity=q.fontsize/10:q.opacity=1;if(q.selected)m="selected";if(q.span==true){k="timeglider-event-spanning";c="<div data-starts='"+q.startdateObj.sec+"' data-ends='"+q.enddateObj.sec+"' class='timeglider-event-spanner' style='top:px;height:"+q.fontsize+"px;width:"+q.spanwidth+"px"+c+"'></div>"}else c=k="";l=q.icon?
"<img class='timeglider-event-icon' src='"+h+q.icon+"' style='height:"+q.fontsize+"px;left:-"+(q.fontsize+2)+"px; top:"+e+"px'>":"";o=x.pol===1?30:-8;f=q.css_class||"";d+="<div class='timeglider-timeline-event "+f+" "+k+" "+m+"' id='"+q.id+"' style='width:"+q.width+"px;height:"+q.height+"px;left:"+q.left+"px;opacity:"+q.opacity+";top:"+(q.top+o)+"px;font-size:"+q.fontsize+"px;'>"+l+g+c+"<div class='timeglider-event-title' style='top:"+e+"px'>"+q.title+"</div></div>"}}}}return{html:d}};var v=function(d,
i){var a=i.importance,k=d.importance;if(d.image&&i.image)return-1;return a<k?-1:a>k?1:0},w=function(d,i){if(i.shape)if(w(d,i.shape)==true)return true;if(!(i.left+-16>d.right||i.right<d.left+-16||i.bottom<d.top+-6))if(i.left>=d.left&&i.left<=d.right||i.right>=d.left&&i.right<=d.right||i.right>=d.right&&i.left<=d.left||i.right<=d.right&&i.left>=d.left)if(i.bottom<=d.bottom&&i.bottom>=d.top||i.top<=d.bottom&&i.top>=d.top||i.bottom==d.bottom&&i.top==d.top)return true;return false},n=function(d,i){var a=
false,k=x.placedBlocks,c=x.placedBlocks.length,g=false;if(c==0||Math.abs(d.top)>i)g=false;else for(var l=0;l<c;l++){sh=false;a=w(k[l],d);if(d.shape)sh=w(k[l],d.shape);if(a==true||sh==true){if(x.pol===-1){d.top-=A;d.bottom-=A;if(d.shape){d.shape.top-=A;d.shape.bottom-=A}}else{d.top+=A;d.bottom+=A;if(d.shape){d.shape.top+=A;d.shape.bottom+=A}}d.attempts++;n(d,i);g=true;break}}if(g==false){x.placedBlocks.push(d);d.shape&&x.placedBlocks.push(d.shape)}}};t.TG_OrgList=function(x,h){var v=t.icon_folder;
this.blocks=x;this.ids=[];this.mediator=h;this.getHTML=function(){var w,n="",d="",i="",a="",k="";a="";var c={};k="";for(var g=this.blocks.length,l="",o=0;o<g;o++){c=this.blocks[o];img_style="";n=c.image?"<div class='tg-event-list-img'><img src='"+c.image.src+"' "+img_style+"></div>":"";b_span_color=c.span_color?";background-color:"+c.span_color:"";c.fontsize<10?c.opacity=c.fontsize/10:c.opacity=1;w=c.span==true?"timeglider-event-spanning":"";icon_img=c.icon?"<img src='"+v+c.icon+"'>":"";d="<div class='tg-event-list-icon'>"+
icon_img+"&nbsp;</div>";l=c.css_class||"";if(c.description){k=c.description.replace(/(<([^>]+)>)/ig,"");a=k.length>110?"...":"";a="<div class='tg-list-blurb'>"+k.substr(0,110)+a+"</div>"}else a="";k=c.startdateObj.format("",true,this.mediator.timeOffset);i+="<li class='tg-list-li timeglider-timeline-event clearfix"+l+" "+w+"' id='"+c.id+"'><div class='tg-list-dateline timeglider-dateline-startdate'>"+k+"</div>"+n+d+"<div class='timeglider-event-title'>"+c.title+"</div>"+a+"</li>"}return{html:i}}}})(timeglider);(function(t){var A=t.TG_Date,x=jQuery,h={},v=A.units,w;t.TG_EventCollection=Backbone.Collection.extend({eventHash:{},comparator:function(n){return n.get("startdateObj").sec},setTimelineHash:function(n,d){this.eventHash[n]=d},getTimelineHash:function(n){return this.eventHash[n]},model:t.TG_Event});t.adjustAllTitleWidths=function(n){_.each(n.models,function(d){var i=t.getStringWidth(d.get("title"));d.set({titleWidth:i})})};t.TG_Event=Backbone.Model.extend({urlRoot:"/event",defaults:{title:"Untitled",
selected:false,css_class:""},initialize:function(n){if(n.image){if(typeof n.image=="string")n.image={id:n.id,scale:n.image_scale||100,src:n.image,display_class:n.image_class||"lane",width:n.image_width||0,height:n.image_height||0};else{n.image.display_class=n.image.display_class||"lane";n.image.width=0;n.image.height=0;n.image.scale=n.image.scale||100}this.getEventImageSize(n.image,n)}else n.image="";n.title=n.title.replace(/&amp;/g,"&");n.description=n.description||"";n.titleWidth=t.getStringWidth(n.title);
n.y_position=n.y_position||0;this.set(n)},getEventImageSize:function(n,d){function i(c,g){return function(){return g.apply(c,arguments)}}var a=this,k=new Image;k.src=n.src;k.onerror=i(k,function(){t.app&&typeof t.app.reportMissingImage=="function"&&t.app.reportMissingImage(n.src,d);a.set({image:{src:n.src,status:"missing"}})});k.onload=i(k,function(){a.get("image").height=this.height;a.get("image").width=this.width;a.get("image").max_height=this.height})},reIndex:function(n){var d=this,i=n||false,
a=d.get("cache"),k=d.get("id"),c=d.get("startdateObj"),g=d.get("enddateObj"),l=d.get("timelines"),o=a.startdateObj||c,q={},b={},e=0,f=0;n=_.union(a.timelines,l);var m=t.TG_Date,j=d.get("mediator"),p=j.timelineCollection,s=j.eventCollection;_.each(n,function(r){q=p.get(r);b=s.getTimelineHash(r);b.all=_.reject(b.all,function(z){return z==k});_.each(m.units,function(z){e=m.getTimeUnitSerial(o,z);if(b[z][e]!==undefined)b[z][e]=_.reject(b[z][e],function(C){return C==k});if(i!=true)if(x.inArray(r,l)!=-1){f=
m.getTimeUnitSerial(c,z);if(b[z][f]!==undefined)b[z][f].push(k);else b[z][f]=[k]}});i!=true&&x.inArray(r,l)!=-1&&b.all.push(k);q.get("bounds");var u=[];_.each(b.all,function(z){z=s.get(z);u.push(z.get("startdateObj").sec);u.push(z.get("enddateObj").sec)});q.set({bounds:{first:_.min(u),last:_.max(u)}});var y=q.get("spans");a.span&&delete y["s_"+k];if(i!=true)if(d.get("span")==true)y["s_"+k]={id:k,start:c.sec,end:g.sec};q.set({has_events:b.all.length})})}});t.TG_Timeline=Backbone.Model.extend({urlRoot:"/timeline",
defaults:{initial_zoom:25,timezone:"00:00",title:"Untitled",with_events:true,events:[],legend:[],tags:{}},_chewTimeline:function(n){w=n.mediator;n.timeline_id=n.id;h=w.options;var d={all:[],da:[],mo:[],ye:[],de:[],ce:[],thou:[],tenthou:[],hundredthou:[],mill:[],tenmill:[],hundredmill:[],bill:[]};n.spans={};n.hasImageLane=false;n.startSeconds=[];n.endSeconds=[];n.initial_zoom=parseInt(n.initial_zoom,10)||25;n.inverted=n.inverted||false;n.size_importance=n.size_importance=="false"||n.size_importance==
"0"?0:1;n.is_public=n.is_public=="false"||n.is_public=="0"?0:1;n.timeOffset=A.getTimeOffset(n.timezone||"00:00");if(!n.color)n.color="#333333";if(n.events.length>0&&!n.preload){for(var i,a,k,c,g=n.events.length,l=0;l<g;l++){a=n.events[l];a.css_class=a.css_class||"";if(a.id)k=a.id;else a.id=k="anon"+this.anonEventId++;a.importance=parseInt(a.importance,10)+h.boost;a.low_threshold=a.low_threshold||1;a.high_threshold=a.high_threshold||100;if(a.map)if(w.main_map){if(timeglider.mapping.ready)a.map.marker_instance=
timeglider.mapping.addAddMarkerToMap(a,w.main_map)}else t.googleMapsLoad();a.callbacks=a.callbacks||{};i=typeof a.date_display=="object"?"da":a.date_display||a.date_limit||"da";a.date_display=i.toLowerCase().substr(0,2);if(a.link){if(typeof a.link=="string"&&a.link.substr(0,4)=="http")a.link=[{url:a.link,label:"link"}]}else a.link="";a.date_display=i.toLowerCase().substr(0,2);a.aPerp="0";if(a.startdate.substr(0,10)=="7777-12-31"||a.startdate=="now"||a.startdate=="today"){a.startdate=A.getToday();
if(a.startdate!="today"){a.aPerp="1";a.css_class+=" ongoing"}}a.zPerp="0";if(typeof a.enddate=="string"&&a.enddate.substr(0,10)=="7777-12-31"||a.enddate=="now"||a.enddate=="today"){a.enddate=A.getToday();if(a.enddate!="today"){a.zPerp="1";a.css_class+=" ongoing"}}if(n.timeOffset.seconds){a.startdate=A.tzOffsetStr(a.startdate,n.timeOffset.string);if(a.enddate)a.enddate=A.tzOffsetStr(a.enddate,n.timeOffset.string)}a.startdateObj=new A(a.startdate,a.date_display);if(a.enddate&&a.enddate!==a.startdate){a.enddateObj=
new A(a.enddate,a.date_display);a.span=true;n.spans["s_"+a.id]={id:a.id,start:a.startdateObj.sec,end:a.enddateObj.sec}}else{a.enddateObj=a.startdateObj;a.span=false}if(a.image)if(a.image.display_class!="inline")n.hasImageLane=true;n.startSeconds.push(a.startdateObj.sec);n.endSeconds.push(a.enddateObj.sec);a.cache={timelines:[n.timeline_id],span:a.span,startdateObj:_.clone(a.startdateObj),enddateObj:_.clone(a.enddateObj)};a.icon=!a.icon||a.icon==="none"?"":a.icon;if(!isNaN(a.startdateObj.sec)&&!isNaN(a.enddateObj.sec)){d.all.push(k);
for(var o=v.length,q=0;q<o;q++){i=v[q];c=A.getTimeUnitSerial(a.startdateObj,i);if(d[i][c]!==undefined)_.indexOf(d[i][c],k)===-1&&d[i][c].push(k);else d[i][c]=[k]}a.mediator=w;if(w.eventCollection.get(k))w.eventCollection.get(k).get("timelines").push(n.timeline_id);else{a.timelines=[n.timeline_id];a=new t.TG_Event(a);w.eventCollection.add(a)}}}g=x.merge(n.startSeconds,n.endSeconds);g=_.sortBy(g,function(b){return parseInt(b)});n.bounds={first:_.first(g),last:_.last(g)};g=A.getDateFromSec(n.bounds.first);
n.focus_date=n.focus_date||g;n.focusDateObj=new A(n.focus_date);n.has_events=1}else{n.tags=n.tags||{test:1};n.focus_date=n.focus_date||"today";n.focusDateObj=new A(n.focus_date);n.bounds={first:n.focusDateObj.sec,last:n.focusDateObj.sec+86400};n.has_events=0}n.hasLegend=n.legend.length>0?true:false;n.display="expanded";w.eventCollection.setTimelineHash(n.timeline_id,d);delete n.events;return n},initialize:function(n){this.set(this._chewTimeline(n));this.bind("change",function(){})}})})(timeglider);(function(t){var A=t.TG_Date,x="",h="",v={},w=0,n=0,d=0,i="",a=jQuery,k={},c="",g,l,o=a.support.touch?"touchstart":"click",q=function(b){if(typeof b=="number")return b;if(!b)return 0;return parseInt(b.replace("px",""),10)};t.TG_TimelinePlayer=function(b,e){var f=this;h=e;h.viewMode="timeline";v=e.options;x="#"+b._id;c=b._id;i=v.base_namespace+"#"+c;this.titleBar=true;this.singleTitleHeight=0;h.setImageLaneHeight(v.image_lane_height,false,true);this._views={PLACE:x,CONTAINER:x+" .timeglider-container",
SCRIM:x+" .tg-scrim",DATE:x+" .tg-footer-center",FOCUS_DATE:x+" .tg-date-display",TIMELINE_MENU:x+" .timeglider-timeline-menu",TIMELINE_MENU_UL:x+" .timeglider-timeline-menu ul",TIMELINE_LIST_BT:x+" .timeglider-list-bt",SLIDER_CONTAINER:x+" .timeglider-slider-container",SLIDER:x+" .timeglider-slider",ZOOM_DISPLAY:x+" .timeglider-zoomlevel-display",TRUCK:x+" .timeglider-truck",CENTERLINE:x+" .timeglider-centerline",TICKS:x+" .timeglider-ticks",HANDLE:x+" .timeglider-handle",FOOTER:x+" .timeglider-footer",
FILTER_BT:x+" .timeglider-filter-bt",FILTER_BOX:x+" .timeglider-filter-box",SETTINGS_BT:x+" .timeglider-settings-bt"};g=this._views.CONTAINER;l=this._views.TICKS;this.ticksHandleOffset=this.rightside=this.leftside=this.tickNum=this.dragSpeed=0;this.timeoout_id=1;this.sliderActive=false;this.ztop=1E3;this.filterBoxActivated=false;this.tick_height=32;this._templates={};this._templates={test:"testola",event_modal_small:"<div class='tg-modal timeglider-ev-modal ui-widget-content ${extra_class}' id='${id}_modal'><div class='tg-close-button tg-close-button-remove'></div><div class='dateline'>{{html dateline}}</div><h4 id='title'>${title}</h4><div class='tg-ev-modal-description jscroll'><p>{{html image}}{{html description}}</p></div><ul class='timeglider-ev-modal-links'>{{html links}}</ul></div>",
event_modal_iframe:"<div class='tg-modal timeglider-ev-modal ui-widget-content tg-iframe-modal' id='${id}_modal'><div class='tg-close-button tg-close-button-remove'></div><div class='dateline'>{{html dateline}}</div><h4 id='title'>{{html title}}</h4><iframe frameborder='none' src='${link}'></iframe></div>",event_modal_full:a.template(null,"<div class='tg-modal tg-full_modal' id='ev_${id}_modal'><div class='tg-full_modal_scrim'></div><div class='tg-full_modal_panel'><div class='tg-full_modal_content'><div class='tg-close-button tg-full_modal_close'></div><div class='dateline'>{{html dateline}}</div><h4>${title}</h4><div class='tg-full_modal-body'>{{html image}}{{html description}}</div><div class='tg-full_modal-links'><ul>{{html links}}</ul></div></div>"),
filter_modal:a.template(null,"<div class='tg-modal timeglider-filter-box'><div class='tg-close-button'></div><h3>search/filter</h3><div class='timeglider-menu-modal-content'><div class='timeglider-formline'><input placeholder='keyword(s)' type='text' class='timeglider-filter-search'></div><div class='tg-filter-cbs'><input type='checkbox' id='filter_t' checked><label for='filter_t'>title</label>&nbsp;&nbsp;&nbsp;<input type='checkbox' id='filter_d'><label for='filter_d'>description</label></div><div class='timeglider-formline filter-tags'><input type='text' id='filter-tags' class='timeglider-filter-tags'></div><ul class='buttons'><li class='timeglider-filter-apply'>go</li><li class='timeglider-filter-clear'>clear</li></ul></div><div class='tg-modal-corner tg-modal-corner-south'></div>"),
timeline_list_modal:a.template(null,"<div class='timeglider-menu-modal timeglider-timeline-menu'><div class='tg-close-button'></div><h3>timelines</h3><div class='timeglider-menu-modal-content'><ul></ul></div><div class='timeglider-menu-modal-point-right'></div>"),settings_modal:a.template(null,"<div class='tg-modal timeglider-settings-modal'><div class='tg-close-button'></div><h3>settings</h3><div class='timeglider-menu-modal-content'><div class='timeglider-settings-timezone'></div></div><div class='tg-modal-corner tg-modal-corner-south'></div>"),
legend_modal:a.template(null,"<div class='timeglider-menu-modal tg-legend tg-display-none'  id='${id}'><div class='tg-close-button-small tg-legend-close'></div><div class='timeglider-menu-modal-content'><ul id='${id}'>{{html legend_list}}</ul><div class='tg-legend-controls'><span class='tg-legend-all'>all</span><span class='tg-legend-none'> | none</span></div></div></div>")};this.timelineInfoModal=Backbone.View.extend({tagName:"div",model:t.TG_Timeline,className:"tg-modal tg-timeline-modal ui-widget-content",
events:{"click .tg-close":"remove","click .tg-timeline-start":"timelineStart","click .tg-modal-tags":"openTagsInfo"},template:function(){var j="",p="";p="";var s=[],r=this.model.get("tags");if(_.size(r)>0){j="<li class='tg-modal-tags'></li>";_.each(r,function(u,y){s.push(y+" ("+u+")")});p="<div class='tg-modal-tags-info'><p class='tags-intro'>Use the search tool (at lower right) to filter this timeline according to these tags:</p>"+s.join(", ")+"</div>"}return"<h4>${title}</h4><div class='tg-close tg-close-button'></div><div class='tg-timeline-description jscroll'>{{html description}}</div><ul>"+
j+"<li data-timeline_id='"+this.model.get("id")+"' class='tg-timeline-start'>start</li></ul>"+p+"<div class='tg-modal-corner tg-modal-corner-north'></div>"},openTagsInfo:function(){a(this.el).find(".tg-modal-tags-info").is(":visible")?a(this.el).find(".tg-modal-tags-info").slideUp():a(this.el).find(".tg-modal-tags-info").slideDown()},timelineStart:function(){h.focusTimeline(this.model.get("id"));this.remove()},initialize:function(){},render:function(){a(this.el).html(a.tmpl(this.template(),this.model.attributes)).attr("id",
this.model.get("id")+"_timelineInfoModal");return this},remove:function(){a(this.el).fadeOut()}});this.presInfoModal=Backbone.View.extend({tagName:"div",model:t.TG_Timeline,className:"tg-modal tg-timeline-modal tg-pres-modal ui-widget-content",events:{"click .tg-close":"remove","click .tg-pres-start":"presStart"},template:function(){return"<div class='tg-timeline-description jscroll'>{{html description}}</div><ul><li class='tg-close'>close</li><li class='tg-pres-start'>start</li></ul><div class='tg-modal-corner tg-modal-corner-north'></div>"},
presStart:function(){var j=h.presentation;h.gotoDateZoom(j.focus_date.dateStr,j.initial_zoom)},render:function(){a(this.el).html(a.tmpl(this.template(),this.model)).attr("id","presInfoModal");return this},remove:function(){a(this.el).fadeOut()}});this.datepicker=Backbone.View.extend({tagName:"div",className:"tg-modal tg-datepicker",events:{"click .tg-close-button":"remove","click .goto-save":"gotoDate"},template:function(){return"<div class='tg-close-button'></div><h3>Go to...</h3><div class='timeglider-menu-modal-content'><div class='tg-dtinput-wrap' id='goto-wrap'> <input class='mousetrap dateinput' type='text' id='goto' value='"+
h.getFocusDate().dateStr.split(" ")[0]+"'><div class='goto-save save button' id='goto-go'>go</div><div class='cal_icon'></div></div></div>"},gotoDate:function(){var j=a(this.el).find("input.dateinput").val();h.gotoDateZoom(j)},render:function(){a(this.el).html(a.tmpl(this.template(),this.model)).attr("id","datepickerModal");a(this.el).find("#goto-wrap").timegliderDatePicker({is_touch_device:false,position:{my:"left bottom",at:"left top",collision:"none"}});return this},remove:function(){a(this.el).remove();
f.datepickerOpen=false}});a(g).delegate(".timeline-info-bt",o,function(){var j=a(this).data("timeline_id");f.timelineModal(j)}).delegate(".tg-expcol-bt",o,function(){var j=a(this).data("timeline_id");f.expandCollapseTimeline(j)}).delegate(".tg-invert-bt",o,function(){var j=a(this).data("timeline_id");f.invertTimeline(j)}).delegate(".tg-legend-bt",o,function(){var j=a(this).data("timeline_id");f.legendModal(j)}).delegate(".tg-close-button-remove",o,function(){a(this).parent().remove()}).delegate(".tg-full_modal_scrim, .tg-full_modal_close",
o,function(){a(".tg-full_modal").remove()}).delegate(".tg-event-overflow",o,function(){h.zoom(-1)}).delegate(".tg-event-overflow","hover",function(){}).delegate(".tg-legend-close",o,function(){var j=a(g+" .tg-legend");j.fadeOut(300,function(){j.remove()});h.setFilters({origin:"legend",icon:"all"},[])}).delegate(".tg-legend-all",o,function(){var j=a(this).closest(".tg-legend");j=h.timelineCollection.get(j.attr("id"));j=_.pluck(j.get("legend"),"icon");if(v.legend.type==="checkboxes"){h.setFilters({origin:"legend",
icon:"provided"},j);a(g+" .tg-legend li").each(function(){a(this).addClass("tg-legend-icon-selected")})}else{h.setFilters({origin:"legend",icon:"all"});a(g+" .tg-legend li").each(function(){a(this).removeClass("tg-legend-icon-selected")})}}).delegate(".tg-legend-none",o,function(){a(g+" .tg-legend li").each(function(){a(this).removeClass("tg-legend-icon-selected")});h.setFilters({origin:"legend",icon:"none"})}).delegate(".tg-timeline-start",o,function(){var j=a(this).data("timeline_id");h.focusTimeline(j)}).delegate(".tg-prev",
o,function(){h.gotoPreviousEvent(true)}).delegate(".tg-next",o,function(){h.gotoNextEvent(true)}).delegate(".timeglider-tick",o,function(j){j=h.getDateFromOffset(j.pageX);h.gotoDateZoom(j.dateStr)}).delegate(".tg-pres-start",o,function(){f.startPresentation()}).delegate(".pres-info-bt",o,function(){f.presentationModal()}).delegate(".tg-pres-header h2",o,function(){f.startPresentation();f.presentationModal()}).delegate(".tg-title-prev-events",o,function(){h.gotoPreviousEvent(true)}).delegate(".tg-title-next-events",
o,function(){h.gotoNextEvent(true)}).css("height",a(x).height());a(".tg-zoom-in").bind(o,function(){h.zoom(-1)});a(".tg-zoom-out").bind(o,function(){h.zoom(1)});a(this._views.FOCUS_DATE).bind(o,function(){f.datepickerModal()});a(window).resize(_.throttle(function(){h.resize()},700));h.base_font_size=v.base_font_size;v.show_footer==false&&a(this._views.FOOTER).css("display","none");this.dimensions=h.dimensions=this.getWidgetDimensions();this.initTimelineVOffset=this.dimensions.container.height-(this.dimensions.footer.height+
this.dimensions.tick.height+18);this.buildSlider();this.setPanButton(a(".timeglider-pan-right"),-30);this.setPanButton(a(".timeglider-pan-left"),30);a(this._views.TRUCK).bind("dblclick",function(j){h.registerUIEvent({name:"dblclick",event:j})}).bind("mousewheel",function(j,p){h.mousewheelChange(-1*(p<0?Math.floor(p):Math.ceil(p)));if(v.mousewheel!=="none")return false});a(l).draggable({axis:"x",start:function(){f.eventUnHover()},containment:[-2E4,0,2E4,0],cancel:".tg-modal",drag:function(){n=Math.floor(a(this).position().left);
h.setTicksOffset(n);w=n-d;d=n;return true},stop:function(){f.resetTicksHandle();f.registerDragging();f.registerTitles()}}).delegate(".timeglider-timeline-event",o,function(){var j=a(this);f.eventUnHover(j);var p=j.attr("id"),s=h.eventCollection.get(p).attributes;if(timeglider.mode!="authoring")if(s.click_callback)try{var r=s.click_callback.split("."),u=r.length,y=true;if(u==1)y=window[r[0]](s);else if(u==2)y=window[r[0]][r[1]](s);else if(u==3)y=window[r[0]][r[1]][r[2]](s);y!==false&&f.eventModal(p,
j)}catch(z){debug.log(s.click_callback+" method cannot be found",z)}else{r=true;if(typeof h.options.eventClick=="function")r=h.options.eventClick(j,s,this);r&&f.eventModal(p,j)}}).delegate(".timeglider-timeline-event","mouseover",function(){f.eventUnHover();var j=h.eventCollection.get(a(this).attr("id")).attributes;f.eventHover(a(this),j)}).delegate(".timeglider-timeline-event","mouseout",function(){h.eventCollection.get(a(this).attr("id"));f.eventUnHover(a(this))}).delegate(".tg-event-collapsed",
"hover",function(){});f.resizeElements();a.subscribe(i+".mediator.ticksOffsetChange",function(){f.tickHangies();f.registerDragging();f.registerTitles()});a.subscribe(i+".mediator.mousewheelChange",function(j){if(j.action==="pan"){f.pan(j.dir*10);f.throttledResetTicksHandle()}});a.subscribe(i+".mediator.focusToEvent",function(){});a.subscribe(i+".mediator.imageLaneHeightSetUi",function(){f.setImageLaneHandle()});a.subscribe(i+".mediator.zoomLevelChange",function(){f.tickNum=0;f.leftside=0;var j=h.getZoomLevel();
a(f._views.SLIDER).slider("value",f.invSliderVal(j));f.displayZoomLevel(j);f.castTicks("zoomLevelChange")});a.subscribe(i+".mediator.initialScope",function(){var j=h.getInitialScope(),p=j.left_sec,s=j.right_sec,r=j.spp,u=a(g).offset(),y=a(g).width();p=Math.floor((p-j.timelineBounds.first)/r)+u.left+y/2;j=-1*Math.ceil((j.timelineBounds.last-s)/r)+u.left-y/2;v.constrain_to_data&&h.activeTimelines.length>0&&a(l).draggable("option","containment",[j,0,p,0])});a.subscribe(i+".mediator.ticksReadySignal",
function(){h.ticksReady===true&&f.freshTimelines()});a.subscribe(i+".mediator.refreshSignal",function(){f.tickNum=0;f.leftside=0;f.castTicks("refreshSignal")});a.subscribe(i+".mediator.ticksArrayChange",function(){});a.subscribe(i+".mediator.scopeChange",function(){h.getScope();h.scopeChanges==1&&f.initiateNavigation();h.scopeChanges++});a.subscribe(i+".mediator.focusDateChange",function(){f.displayFocusDate()});a.subscribe(i+".mediator.timelineDataLoaded",function(){if(h.singleTimelineID)f.setupSingleTimeline();
else{f.buildTimelineMenu(h.timelineCollection);timeglider.mode=="presentation"&&f.setupPresentation()}f.buildSettingsMenu();f.setupFilter();a(".timeglider-loading").fadeOut(500)});a.subscribe(i+".mediator.activeTimelinesChange",function(){a(f._views.TIMELINE_MENU_UL+" li").each(function(){var j=a(this).data("timeline_id");_.indexOf(h.activeTimelines,j)!=-1?a(this).addClass("activeTimeline"):a(this).removeClass("activeTimeline")})});a.subscribe(i+".mediator.filterChange",function(){});a.subscribe(i+
".mediator.resize",function(){f.resize()});if(a.support.touch){a("#"+c).addTouch();var m=document.getElementById(c);m.addEventListener("gesturestart",function(j){j.preventDefault();a("#output").append("<br>gesture zoom:"+h.getZoomLevel())},false);m.addEventListener("gestureend",function(j){j.preventDefault();a("#output").append("<br>gesture end:"+h.getZoomLevel())},false);m.addEventListener("gesturechange",function(j){j.preventDefault();j.preventDefault();if(h.gesturing===false){h.gesturing=true;
h.gestureStartZoom=h.getZoomLevel()}h.setZoomLevel(Math.ceil(h.gestureStartZoom/(j.scale/2)))},false)}};t.TG_TimelinePlayer.prototype={resize:function(){var b=a(x).height();a(g).height(b);this.dimensions=this.getWidgetDimensions();h.setDimensions(this.dimensions);this.resizeElements();h.refresh()},getWidgetDimensions:function(){var b=a(g),e=b.width(),f=Math.floor(e/2)+1,m=b.height(),j=Math.floor(m/2),p=this.tick_height,s=b.position().left;b=b.offset();var r=v.show_footer==true?a(this._views.FOOTER).outerHeight():
0,u=m-r-p,y=m-(r+p);head_ht=a(".tg-widget-header").outerHeight();return{container:{width:e,height:m,centerx:f,centery:j,left:s,offset:b},ticks:{height:y},tick:{top:u,height:p},header:{height:head_ht},footer:{height:r}}},initiateNavigation:function(){var b=this;a(".tg-single-timeline-header .tg-timeline-start").fadeIn();a(g).delegate(".tg-single-timeline-header h2",o,function(){b.timelineModal(h.singleTimelineID);h.focusTimeline(h.singleTimelineID)})},displayZoomLevel:function(){var b=h.getZoomLevel();
b>0&&v.display_zoom_level==true&&a(this._views.ZOOM_DISPLAY).text(b)},displayFocusDate:_.throttle(function(){var b=h.getFocusDate().format("d MMM yyyy",true);a(this._views.FOCUS_DATE).find("span").text(b)},300),displayOutOfFrameEvents:_.throttle(function(){h.getPastEvents(true,true);h.getFutureEvents(true,true)},900),setPanButton:function(b,e){var f=this;a(b).bind("mousedown",function(){f.intervalMachine("pan",{type:"set",fn:f.pan,args:[e],intvl:33})}).bind("mouseup",function(){f.intervalMachine("pan",
{type:"clear",fn:f.pan,callback:"resetTicksHandle"})}).bind("mouseout",function(){f.intervalMachine("pan",{type:"clear",fn:f.pan,callback:"resetTicksHandle"})})},intervalMachine:function(b,e){var f=this;if(e.type==="clear"){clearInterval(k[b]);if(e.callback)f[e.callback]()}else k[b]=setInterval(function(){e.fn.apply(f,e.args)},e.intvl)},invSliderVal:function(b){return Math.abs(b-101)},pan:function(b){var e=b||20;b=a(l);e=b.position().left+e;b.css({left:e});h.setTicksOffset(e)},registerTitles:function(){var b,
e,f,m,j,p,s,r,u,y,z=a(g).offset().left;a(g+" .timeglider-event-spanning").each(function(){var C=a(this);b=C.offset().left-z;j=C.find(".timeglider-event-title");e=j.outerWidth();f=j.siblings(".timeglider-event-spanner").outerWidth();if(f>e)if(b<0)Math.abs(b)<f-e?j.css({marginLeft:-1*b+5}):j.css({marginLeft:f-e-5});else j.css({marginLeft:5})});a(g+" .tg-timeline-envelope").each(function(){p=a(this);s=p.offset().left-z;r=p.find(".titleBar");m=r.data("lef");y=-1*(m+s);u=r.find(".timeline-title");if(y>
0){var C=r.width()-u.width();y<C?u.css({marginLeft:y+5}):u.css({marginLeft:C-5})}else u.css({marginLeft:5})})},registerDragging:function(){var b=h.startSec,e=a(l).position().left,f=h.getZoomInfo().spp;b=new A(b-e*f);h.setFocusDate(b);this.displayFocusDate();this.displayOutOfFrameEvents()},getTimelinesTagsArray:function(){var b=[],e;_.each(h.timelineCollection.models,function(f){e=f.get("tags");_.each(e,function(m,j){b.push(j)})});return b},setupFilter:function(){var b=this;a(b._views.FILTER_BT);var e=
a.tmpl(b._templates.filter_modal,{}).appendTo(b._views.CONTAINER),f=false,m=false,j=b._views.FILTER_BOX,p=function(){h.setFilters({origin:"title_andor_desc",title:"",tags:"",description:""});a(j+" .timeglider-filter-search").val("");a(j+" .timeglider-filter-tags").val("");a("#filter-tags").val("").trigger("change")},s=function(){h.clearFilters({legend:false,custom:false})},r=b.getTimelinesTagsArray();if(r.length>0)a.fn.select2&&a("#filter-tags").select2({tags:r,placeholder:"Click to select",allowClear:true});
else a(".filter-tags").hide();e.position({my:"right+32 bottom-16",at:"right top",of:a(b._views.FILTER_BT)}).css("z-index",b.ztop++).hide();a(g).delegate(".timeglider-filter-box .tg-close-button","click",function(){p();e.fadeOut()});a(b._views.FILTER_BT).bind("click",function(){e.fadeIn();a(this);if(b.filterBoxActivated==false){b.filterBoxActivated=true;var u=a(j+" .timeglider-filter-apply"),y=a(j+" .timeglider-filter-clear"),z="",C="",D="",F="";u.bind("click",function(){s();C=a("#filter-tags").val();
z=a(j+" .timeglider-filter-search").val();f=a(j+" input#filter_t").is(":checked");m=a(j+" input#filter_d").is(":checked");if(f&&z||m&&z||C){D=f?z:"";F=m?z:"";f&&m&&z?h.setFilters({origin:"clude",include:D,exclude:"",tags:C}):h.setFilters({origin:"title_andor_desc",title:D,description:F,tags:C})}else{s();p()}});y.bind("click",function(){s();p()})}})},buildTimelineMenu:function(){var b=this,e;a(b._views.FOOTER).append("<div class='timeglider-footer-button timeglider-list-bt'></div>");a(b._views.TIMELINE_MENU)[0]&&
a(b._views.TIMELINE_MENU).remove();e=a.tmpl(b._templates.timeline_list_modal,{}).appendTo(b._views.CONTAINER);var f=Backbone.View.extend({initialize:function(){this.model.bind("change",this.render,this)},tagName:"li",className:"timeglider-timeline-list-item",template:"${title}",events:{click:"toggleTimeline"},toggleTimeline:function(){h.toggleTimeline(this.model.get("id"))},render:function(){var m=this.model.get("id");a(this.el).html(a.tmpl(this.template,this.model.attributes)).data("timeline_id",
m);return this}});a(b._views.TIMELINE_MENU_UL).html("");_.each(h.timelineCollection.models,function(m){a(b._views.TIMELINE_MENU_UL).append((new f({model:m})).render().el)});e.position({my:"right-8 bottom-30",at:"right top",of:a(b._views.TIMELINE_LIST_BT)}).hide();a(g).delegate(".timeglider-timeline-menu .tg-close-button","click",function(){e.fadeOut()}).delegate(this._views.TIMELINE_LIST_BT,"click",function(){e.fadeIn()})},getTimezonePulldown:function(b,e){var f="<select name='timezone' id='"+b+"'>",
m=false,j="selected";a.map(A.timezones,function(p){if(e==p.offset&&m==false){j="selected";m=true}else j="";f+="<option value='"+p.offset+"' "+j+">"+p.name+"</option>"});f+="</select>";return f},buildSettingsMenu:function(){var b=a.tmpl(this._templates.settings_modal,{}).appendTo(this._views.CONTAINER),e=this.getTimezonePulldown("timeglider-settings-timezone",h.timeOffset.string);b.find(".timeglider-settings-timezone").append('<span class="settings-label">timezone:</span> '+e+'<br><a class="btn" id="timeglider-settings-save">save</a>');
b.position({my:"right+32 bottom-16",at:"right top",of:a(this._views.SETTINGS_BT)}).hide();a(g).delegate(".timeglider-settings-modal .tg-close-button","click",function(){b.fadeOut()});a(this._views.SETTINGS_BT).bind(o,function(){debug.log("settings!");b.fadeIn()}).find("#timeglider-settings-save").bind(o,function(){var f=a(g+" #timeglider-settings-timezone").val();h.setTimeoffset(f);a(".timeglider-settings-modal").fadeOut()})},setupSingleTimeline:function(){var b=this,e=h.singleTimelineID,f=h.timelineCollection.get(e);
if(h.options.display_single_timeline_info!=false){var m="<h2>"+f.get("title")+"</h2>";inf=f.get("description")?"<li id='info' class='timeline-info-bt' data-timeline_id='"+e+"'>info</li>":"";leg=f.get("hasLegend")?"<li id='legend' class='tg-legend-bt' data-timeline_id='"+e+"'>legend</li>":"";tools="";tmpl="<div class='tg-widget-header tg-single-timeline-header'>"+m+"<ul>"+inf+leg+"<li class='tg-timeline-start' data-timeline_id='"+e+"'>start</li></ul>"+tools+"</div>";$st=a(tmpl).appendTo(g);b.singleTitleHeight=
$st.outerHeight()}else b.singleTitleHeight=0;f.get("hasImageLane")&&b.buildImageLane();a(b._views.SLIDER_CONTAINER).css("top",b.singleTitleHeight+4);v.initial_timeline_modal!=false&&b.timelineModal(e);f.get("hasLegend")&&setTimeout(function(){b.legendModal(e)},500)},presentationModal:function(){if(h.presentation.description){var b=this.dimensions.container.height,e=new this.presInfoModal({model:h.presentation});$modal=a(e.render().el).appendTo(a(".timeglider-container")).position({my:"left+16 top+39",
at:"left top",of:a(".timeglider-container"),collision:"fit fit"}).css({"z-index":this.ztop++,"max-height":b-64});a.jScrollPane&&a(".jscroll").jScrollPane()}},datePickerOpen:false,datepickerModal:function(){var b;if(!this.datepickerOpen){b=this;var e=b.dimensions.container.height,f=new this.datepicker({model:{}});$modal=a(f.render().el).appendTo(a(".timeglider-container")).position({my:"center bottom-39",at:"center bottom",of:a(".timeglider-container"),collision:"fit fit"}).css({"z-index":b.ztop++,
"max-height":e-64});b.datepickerOpen=true}},startPresentation:function(){var b=h.presentation;h.gotoDateZoom(b.focus_date.dateStr,b.initial_zoom)},setupPresentation:function(){var b=h.presentation,e=a("<div class='tg-widget-header tg-pres-header'>"+("<h2 class='no-select'>"+b.title+"</h2>")+"<ul>"+(b.description?"<li id='info' class='pres-info-bt'>info</li>":"")+(b.legend?"<li id='legend' class='tg-legend-bt'>legend</li>":"")+"<li class='tg-pres-start'>start</li></ul></div>").appendTo(g);this.getWidgetDimensions();
this.singleTitleHeight=e.outerHeight();b.image_lane_height&&this.buildImageLane();a(this._views.SLIDER_CONTAINER).css("top",this.singleTitleHeight+4);this.startPresentation();b.open_modal&&b.description&&this.presentationModal()},buildImageLane:function(){var b=this;if(a(g).find(".tg-image-lane-pull").length==0){a("<div class='tg-image-lane-pull'><div title='This is the image lane!' class='tg-image-lane-bg'></div></div>").appendTo(g).draggable({axis:"y",containment:"parent",drag:function(){var e=
a(this),f=e.position().top;if(f>400){e.css("top",400);return false}else if(f<5){e.css("top",5);return false}},stop:function(){h.setImageLaneHeight(a(this).position().top-b.singleTitleHeight,true,false)}});b.setImageLaneHandle()}},setImageLaneHandle:function(){var b=parseInt(h.image_lane_height,10)+parseInt(this.singleTitleHeight,10);a(".tg-image-lane-pull").css("top",b+"px")},buildSlider:function(){var b=this,e=h.getZoomLevel();if(v.min_zoom==v.max_zoom)a(this._views.SLIDER_CONTAINER).css("display",
"none");else{v.display_zoom_level==true&&a("<div>").appendTo(this._views.SLIDER_CONTAINER).addClass("timeglider-zoomlevel-display").html("&nbsp;");b=this;e=b.invSliderVal(e);var f=h.max_zoom,m=h.min_zoom,j=(1+f-m)*3;a(this._views.SLIDER).css({height:j}).slider({steps:100,handle:a(".knob"),animate:300,orientation:"vertical",min:b.invSliderVal(f),max:b.invSliderVal(m),value:e,start:function(){b.sliderActive=true},stop:function(){b.sliderActive=false},change:function(){},slide:function(p,s){h.setZoomLevel(b.invSliderVal(s.value))}})}},
getEventDateLine:function(b){var e="<span class='timeglider-dateline-startdate'>"+b.startdateObj.format("",true,h.timeOffset)+"</span>",f="";if(b.span==true)f=" &ndash; <span class='timeglider-dateline-enddate'>"+b.enddateObj.format("",true,h.timeOffset)+"</span>";return e+f},eventHover:function(b,e){var f=true;if(typeof h.options.eventHover=="function")f=h.options.eventHover(b,e,this);if(f){f=a(".timeglider-event-hover-info");var m="",j="";b.append("<div class='tg-event-hoverline'></div>").addClass("tg-event-hovered");
j=e.date_display=="no"?"":this.getEventDateLine(e);if((m=b.hasClass("tg-event-collapsed")||b.hasClass("tg-event-overflow")?"<div>"+e.title+"</div>":"")||j)f.position({my:"left+1 top+4",at:"left bottom",of:b,collision:"flip flip"}).html(m+j)}},eventUnHover:function(b){b=b||"";if(typeof h.options.eventUnHover=="function")h.options.eventUnHover(b,this);else{a(".timeglider-event-hover-info").css("left","-1000px");a(".timeglider-timeline-event").removeClass("tg-event-hovered");b&&b.find(".tg-event-hoverline").remove()}},
clearTicks:function(){this.tickNum=this.leftside=0;a(l).css("left",0);a(g+" .tg-timeline-envelope").remove();a(g+" .timeglider-tick").remove()},castTicks:function(){if(h.viewMode=="timeline"){this.clearTicks();h.getZoomLevel();var b=h.getFocusDate(),e=h.getZoomInfo(),f=Math.ceil(this.dimensions.container.width/e.width)+4,m="l";if(typeof e.width=="number"){h.setTicksReady(false);this.addTick({type:"init",focus_date:b});for(b=1;b<=f;b+=1){this.addTick({type:m});m=m=="l"?"r":"l"}h.setTicksReady(true);
this.displayFocusDate()}}else{this.clearTicks();this.freshTimelines()}},getTickTop:function(){var b=typeof h.options.tick_top;return b=="number"?h.options.tick_top:b=="function"?h.options.tick_top(me.dimensions):parseInt(this.dimensions.tick.top)},addTick:function(b){var e=0,f=0,m=f=0,j=0,p=0,s=p="",r={};p={};m={};var u={};p={};r="";r=[];var y="";y=h.getZoomInfo().unit;u=h.getZoomInfo().width;j=h.getFocusDate();m=this.getTickTop();j=h.addToTicksArray({type:b.type,unit:y},j);if(y=="mo"){p=A.getMonthAdj(j,
u);u=p.width;e=p.days}this.tickNum++;if(b.type=="init"){p=this.tickOffsetFromDate(h.getZoomInfo(),h.getFocusDate(),u);f=Math.ceil(this.dimensions.container.centerx+p);a(l).data("init-left",f);this.leftside=f;this.rightside=f+u}else if(b.type=="l")this.leftside=f=Math.floor(this.leftside-u);else if(b.type=="r"){f=Math.floor(this.rightside);this.rightside+=u}h.getTickBySerial(j).width=u;h.getTickBySerial(j).left=f;p=this._views.PLACE+"_"+y+"_"+j+"-"+this.tickNum;p=a("<div class='timeglider-tick "+(j%
2==0?"tg-even-tick":"tg-odd-tick")+"' id='"+p+"'><div class='tg-tick-body'><div class='tg-tick-leftline'></div><div class='timeglider-tick-label'></div><div class='tg-tick-label-bottom'></div></div>").appendTo(l);p.css({width:u,left:f,top:m,zIndex:55});m=this.getTickMarksInfo({unit:y,width:u});m=e||m.tperu;f=u/m;if(f>8){b=10;for(b=e=0;b<m;b++){s="&nbsp;";if(f>16)if(y=="da")s=this.getHourLabelFromHour(b,f);else if(y=="mo")s=b+1;else if(y=="ye")s=f>30?"&nbsp;"+A.monthNamesAbbr[b+1]:"&nbsp;"+A.monthNamesLet[b+
1];else if(y=="de"){if(f>54)s=j*10+b}else{if(y=="ce")if(f>38)s=(j*10+b)*10}else s="";r.push("<div class='timeglider-tick-sub-label "+y+"' style='left:"+e+"px;width:"+f+"px'>"+s+"</div>");e+=f}j<0&&r.reverse();r=r.join("")}else r="";r&&p.append("<div class='tg-tick-sublabel-group' style='width:"+(u+10)+"px;'>"+r+"</div>");u={unit:y,width:u,serial:j};r=this.getDateLabelForTick(u);u.seconds=this.getTickSeconds[y](u.serial);p.find(".timeglider-tick-label").text(r);b=this.dimensions.container.height-(h.options.show_footer?
46:14);p.find(".tg-tick-label-bottom").text(r).css("top",b);return u},resizeElements:function(){var b=this.dimensions.container.centerx,e=this.dimensions.container.height,f=this.dimensions.container.width,m=this.dimensions.footer.height,j=this.dimensions.tick.height,p=a(this._views.CENTERLINE),s=a(this._views.DATE),r=b-s.width()/2;h.options.show_centerline===true?p.css({height:e,left:b}):p.css({display:"none"});a(this._views.TICKS).css("height",e-(m+j));e<500||f<500?a(".timeglider-slider").css("display",
"none"):a(".timeglider-slider").css("display","block");s.css({left:r})},getTickSeconds:{da:function(b){b*=86400;return{start:b,end:b+86400}},mo:function(b){b*=2629800;return{start:b,end:b+2629800}},ye:function(b){b*=3154E4;return{start:b,end:b+3154E4}},de:function(b){b*=3154E5;return{start:b,end:b+3154E5}},ce:function(b){b*=3154E6;return{start:b,end:b+3154E6}},thou:function(b){b*=3154E6;return{start:b,end:b+3154E6}},tenthou:function(b){b*=3154E6;return{start:b,end:b+3154E6}},hundredthou:function(b){b*=
3154E6;return{start:b,end:b+3154E6}},mill:function(b){b*=3154E6;return{start:b,end:b+3154E6}},tenmill:function(b){b*=3154E6;return{start:b,end:b+3154E6}},hundredmill:function(b){b*=3154E7;return{start:b,end:b+3154E7}},bill:function(b){b*=3154E8;return{start:b,end:b+3154E8}}},getHourLabelFromHour:function(b,e){var f="",m=b,j="";j=0;if(e<16)return"";else{if(b>12)m=b-12;else if(b==0)m=12;if(e>30)f=b>11?" pm":" am";if(e>200){j=e/4-4;return"<div class='minutes' style='width:"+j+"px'>"+m+":00 "+f+"</div><div class='minutes' style='width:"+
j+"px'>"+m+":15 "+f+"</div><div class='minutes' style='width:"+j+"px'>"+m+":30 "+f+"</div><div class='minutes' style='width:"+j+"px'>"+m+":45 "+f+"</div>"}else return m+(e>60?":00":"")+f}},getTickMarksInfo:function(b){switch(b.unit){case "da":b=24;break;case "mo":b=30;break;case "ye":b=12;break;default:b=10}return{tperu:b}},getDateLabelForTick:function(b){var e=b.serial,f=b.width;switch(b.unit){case "bill":return e==0?"1":e>0?e+" billion":e+" b.y. bce";case "hundredmill":return e==0?"1":e>0?e+"00 million":
e+"00 m.y. bce";case "tenmill":return e==0?"1":e>0?e+"0 million":e+"0 m.y. bce";case "mill":return e==0?"1":e>0?e+" million":e+" m.y. bce";case "hundredthou":return e==0?"1":e>0?e+"00,000":e+"00,000 bce";case "tenthou":return e==0?"1":e>0?e+"0,000":e+"0,000 bce";case "thou":return e==0?"1("+e+")":e>0?e+"000":e+"000 bce";case "ce":return e==0?"1("+e+")":e>0?e+"00":e+"00 bce";case "de":return e>120?e*10+"s":e*10;case "ye":return e;case "mo":b=A.getDateFromMonthNum(e);return f<120?A.monthNamesAbbr[b.mo]+
" "+b.ye:A.monthNames[b.mo]+", "+b.ye;case "da":b=new A(A.getDateFromRD(e));return f<120?A.monthNamesAbbr[b.mo]+" "+b.da+", "+b.ye:A.monthNames[b.mo]+" "+b.da+", "+b.ye;default:return b.unit+":"+e+":"+f}},tickHangies:function(){var b=a(l).position().left,e=this.rightside+b-this.dimensions.container.width;if(this.leftside+b>-100){b=this.addTick({type:"l"});this.appendTimelines(b,"left")}else if(e<100){b=this.addTick({type:"r"});this.appendTimelines(b,"right")}},tickOffsetFromDate:function(b,e,f){switch(b.unit){case "da":e=
e.ho/24+e.mi/1440;f*=e;break;case "mo":b=A.getMonthDays(e.mo,e.ye);e=(e.da-1)/b+e.ho/(24*b)+e.mi/(1440*b);f*=e;break;case "ye":e=((e.mo-1)*30+e.da)/365;f*=e;break;case "de":e=e.ye%10/10+e.mo/120;f*=e;break;case "ce":e=e.ye%100/100+e.mo/1200;f*=e;break;case "thou":e=e.ye%1E3/1E3;f*=e;break;case "tenthou":e=e.ye%1E4/1E4;f*=e;break;case "hundredthou":e=e.ye%1E5/1E5;f*=e;break;case "mill":e=e.ye%1E6/1E6;f*=e;break;case "tenmill":e=e.ye%1E7/1E7;f*=e;break;case "hundredmill":e=e.ye%1E8/1E8;f*=e;break;case "bill":e=
e.ye%1E9/1E9;f*=e;break;default:f=0}return-1*f},resetTicksHandle:function(){a(this._views.HANDLE).offset({left:a(g).offset().left})},throttledResetTicksHandle:_.throttle(function(){this.resetTicksHandle()},500),easeOutTicks:function(){Math.abs(w)>5&&a(l).animate({left:"+="+3*w},1E3,"easeOutQuad",function(){debug.trace("stopping easing","note")})},getTimelineEventsByTick:function(b){var e=b.tick.unit,f=b.tick.serial;b=h.eventCollection.getTimelineHash(b.timeline.timeline_id);return b[e][f]&&b[e][f].length>
0?b[e][f]:[]},passesFilters:function(b,e){var f=true,m="";m="";var j=[],p;m="";p=[];p=[];if(e<b.low_threshold||e>b.high_threshold)return false;if(h.filters.imp_min&&h.filters.imp_min>1)if(b.importance<h.filters.imp_min)return false;if(h.filters.imp_max&&h.filters.imp_max<100)if(b.importance>h.filters.imp_max)return false;if(h.filters.include){f=false;j=h.filters.include.split(",");for(p=0;p<j.length;p++){m=RegExp(a.trim(j[p]),"i");if(b.title.match(m)||b.description.match(m))f=true}}else{if(h.filters.title){m=
h.filters.title;p=m.split(",");f=false;for(j=0;j<p.length;j++){m=RegExp(a.trim(p[j]),"i");if(b.title.match(m))f=true}}if(h.filters.description){desr=h.filters.description;p=desr.split(",");f=false;for(j=0;j<p.length;j++){m=RegExp(a.trim(p[j]),"i");if(b.description.match(m))f=true}}}if(h.filters.exclude){j=h.filters.exclude.split(",");for(p=0;p<j.length;p++){m=RegExp(a.trim(j[p]),"i");if(b.title.match(m)||b.description.match(m))f=false}}if(h.filters.legend.length>0){m=b.icon;if(_.indexOf(h.filters.legend,
m)==-1)f=false}if(h.filters.tags.length>0)if(b.tags){f=false;ev_tags=b.tags.split(",");_.each(ev_tags,function(s){s=a.trim(s);if(_.indexOf(h.filters.tags,s)!==-1)f=true})}else f=false;if(h.filters.custom&&typeof h.filters.custom=="function")f=h.filters.custom(b);return f},freshTimelines:function(){var b=this,e,f,m,j=h.activeTimelines,p=h.ticksArray,s="",r,u,y;f="";var z=b.dimensions.container.centerx,C=b.dimensions.container.width,D=h.getFocusDate().sec,F=h.getZoomInfo(),B=F.spp;F=F.unit;f=[];var G=
[];C=Math.floor(B*(C/2));var L=D-C,M=D+C;m=m=0;var J,H=0;H=0;var I=h.options.minimum_timeline_bottom,N=b.dimensions.ticks.height;a.publish(i+".viewer.rendering");for(C=0;C<j.length;C++){G=[];f=h.timelineCollection.get(j[C]);e=f.attributes;e.visibleEvents=[];if(h.viewMode=="timeline"){J=e.display;tl_bottom=e.bottom?q(e.bottom):I;if(tl_bottom<I)tl_bottom=I;H=N-tl_bottom;I=h.options.minimum_timeline_bottom;f=new t.TG_TimelineView({model:f});m=h.timeOffset.seconds/B;u=a(f.render().el).appendTo(l);r=u.find(".titleBar");
r.outerHeight();b.room=H;u.draggable({axis:"y",handle:".titleBar",stop:function(){a(this).position();var E=N-q(a(this).css("top"))-1;if(E<I){a(this).css("bottom",I);E=I}var K=a(this).attr("id");h.timelineCollection.get(K).set({bottom:E});r.outerHeight();b.room=b.dimensions.ticks.height-E;h.refresh()}}).css({bottom:tl_bottom,left:m});if(typeof e.bounds!="undefined"){f=z+(e.bounds.first-D)/B;m=z+(e.bounds.last-D)/B}else{f=z;m=z+300}m=Math.floor(m-f);if(m>1E6){var P=m-1E6;m=1E6;if(f<-998E3)f+=P}r.css({top:void 0,
left:f,width:m}).data({lef:f,wid:m});if(J=="expanded")e.borg=s=new timeglider.TG_Org;for(m=0;m<p.length;m++){f=p[m];f=this.getTimelineEventsByTick({tick:f,timeline:e});G=_.union(G,f)}e.visibleEvents=G;_.each(e.spans,function(E){if(_.indexOf(G,E.id)===-1)if(E.start<L&&E.end>M||E.end<M&&E.end>L){G.unshift(E.id);e.visibleEvents.push(E.id)}});f=this.compileTickEventsAsHtml(e,_.uniq(G),0,"sweep",F);H=v.event_overflow=="scroll"?1E4:e.inverted?tl_bottom-16:e.hasImageLane||t.mode=="authoring"?H-h.image_lane_height-
b.singleTitleHeight:H-b.singleTitleHeight;m=e.initial_zoom==h.getZoomLevel();if(J=="expanded"){f=s.getHTML({tickScope:"sweep",ceiling:H,onIZoom:m,inverted:e.inverted});e.borg=s.getBorg()}f!="undefined"&&u.append(f.html);setTimeout(function(){b.registerEventImages(u)},100)}else if(h.viewMode=="list"){a("#tg-list-wrapper").remove();a("<div id='tg-list-wrapper'><div id='tg-list' class='tg-list-events'><ul id='list-events-ul' class='list-ul'></ul></div></div>").prependTo(g);s=h.eventCollection.getTimelineHash(f.get("id"));
var O=[];_.each(s.all,function(E){y=h.eventCollection.get(E).attributes;b.passesFilters(y,0)===true&&O.push(y)});s=new timeglider.TG_OrgList(O,h);f=s.getHTML();f!="undefined"&&a(".tg-list-events ul").append(f.html);t.listIScroll=new iScroll("tg-list-wrapper");setTimeout(function(){a(".tg-legend .tg-legend-close").trigger(o)},300);a(".tg-list-li").bind("click",function(){debug.log("myscroll:",t.listIScroll.distance);if(t.listIScroll.distance>20||t.listIScroll.moved)return false;var E=a(this),K=E.attr("id");
b.eventModal(K,E)})}}b.registerTitles();setTimeout(function(){b.applyFilterActions()},300);setTimeout(function(){h.setInitialScope()},500);a.publish(i+".viewer.rendered")},appendTimelines:function(b,e){var f=h.activeTimelines,m=[],j,p="",s=0,r=this;a.publish(i+".viewer.rendering");for(var u=0;u<f.length;u++){j=h.timelineCollection.get(f[u]).attributes;m=this.getTimelineEventsByTick({tick:b,timeline:j});j.visibleEvents=_.union(j.visibleEvents,m);tl_top=j.top?q(j.top):r.initTimelineVOffset;e=="left"&&
_.each(j.spans,function(z){if(z.end<b.seconds.end&&z.end>b.seconds.start)if(_.indexOf(j.visibleEvents,z.id)===-1){m.unshift(z.id);j.visibleEvents.push(z.id)}});p=this.compileTickEventsAsHtml(j,m,b.serial,"append",b.unit);s=v.event_overflow=="scroll"?1E4:j.hasImageLane?tl_top-h.image_lane_height-r.singleTitleHeight:tl_top;var y=j.initial_zoom==h.getZoomLevel();if(j.display=="expanded")p=j.borg.getHTML({tickScope:b.serial,ceiling:s,onIZoom:y,inverted:j.inverted});a(g+" .tg-timeline-envelope#"+j.id).append(p.html);
this.registerEventImages(void 0)}setTimeout(function(){r.applyFilterActions()},500);a.publish(i+".viewer.rendered")},compileTickEventsAsHtml:function(b,e,f,m,j){var p=0,s=this.dimensions.container.centerx,r=b.display,u="",y=h.startSec,z=h.getZoomInfo(),C=z.spp;z=z.level;var D=p=0,F=b.borg||"",B={};D=p=0;var G="sweep";F&&b.borg.clearFresh();if(m=="append")G=f;for(f=0;f<e.length;f++){B=h.eventCollection.get(e[f]).attributes;if(this.passesFilters(B,z)===true){p=s+(B.startdateObj.sec*(!(j=="da"||j=="mo"||
j=="ye"||j=="de"||j=="ce"||j=="thou")?0.99795:1)-y)/C;if(r=="expanded"){m=b.size_importance===true||b.size_importance===1?t.scaleToImportance(B.importance,z):1;B.width=B.titleWidth*m+16;B.fontsize=h.base_font_size*m;B.left=p;B.spanwidth=0;if(B.span==true){B.spanwidth=(B.enddateObj.sec-B.startdateObj.sec)/C;if(B.spanwidth>B.width)B.width=B.spanwidth+16}p=Math.ceil(B.fontsize);B.height=p+4;B.top=0-p;B.bottom=0;if(B.image&&B.image.display_class=="inline"){m=(B.image.scale||100)/100;p=m*B.image.height+
2;D=m*B.image.width+2;B.shape={img_ht:p,img_wi:D,title:"shape",top:B.top-(p+8),bottom:B.bottom,left:B.left,right:B.left+(D+8)}}else B.shape="";F.addBlock(B,G)}else if(r=="collapsed"){D=b.inverted?4:-20;colIcon=B.icon?t.icon_folder+B.icon:t.icon_folder+"shapes/circle_white.png";u+="<div id='"+B.id+"' class='timeglider-timeline-event tg-event-collapsed' style='top:"+D+"px;left:"+p+"px'><img src='"+colIcon+"'></div>"}}}return r=="collapsed"?{html:u}:""},registerEventImages:function(){var b=h.image_lane_height,
e=this.singleTitleHeight;if(b>400)b=400;a(g+" .timeglider-event-image-lane").each(function(){var f=a(this),m=b-2,j=a(this).find("img"),p=parseInt(f.data("max_height"),10)||400;if(p<m)m=p;if(m>10){f.css({display:"block"}).position({my:"center top+"+(e+4),at:"center top",of:a(g)}).css({left:0});j.css("height",m-4)}else f.css({display:"none"})})},applyFilterActions:function(){var b=h.filterActions,e=h.eventCollection.models,f;_.isEmpty(b)||_.each(b,function(m){_.each(e,function(j){if(m.filter(j)){f=
j.get("id");m.fn(a(".timeglider-timeline-event#"+f))}})})},expandCollapseTimeline:function(b){b=h.timelineCollection.get(b).attributes;b.display=b.display=="expanded"?"collapsed":"expanded";h.refresh()},invertTimeline:function(b){b=h.timelineCollection.get(b).attributes;b.inverted=b.inverted==false?true:false;h.refresh()},timelineModal:function(b){a(".tg-timeline-modal").remove();var e=h.timelineCollection.get(b);if(e.get("description")){b=this.dimensions.container.height;e=new this.timelineInfoModal({model:e});
a(".tg-widget-header").outerHeight();a(".timeglider-container").position();b=a(e.render().el).appendTo("body").position({my:"left+16 top+39",at:"left top",of:a(".timeglider-container"),collision:"none none"}).css({"z-index":this.ztop++,"max-height":b-64});h.singleTimelineID&&b.find("h4").hide();a.fn.jScrollPane&&a(".jscroll").jScrollPane()}},createEventLinksMenu:function(b){if(!b)return"";var e="",f=0,m="",j="";if(typeof b=="string")e="<li><a href='"+b+"' target='_blank'>link</a></li>";else if(typeof b==
"object")for(f=0;f<b.length;f++){m=b[f].url;j=b[f].label;e+="<li><a href='"+m+"' target='_blank'>"+j+"</a></li>"}return e},eventModal:function(b,e){a.publish(i+".viewer.eventModal");a(g+" #"+b+"_modal").remove();var f=this,m=false,j=false,p="";p={};var s;p=0;var r=h.eventCollection.get(b).attributes;s=r.modal_type||v.event_modal.type;var u=r.image&&r.image.src?"<img src='"+r.image.src+"'>":"",y=this.createEventLinksMenu(r.link);u={id:r.id,title:r.title,description:r.description,link:r.link,dateline:f.getEventDateLine(r),
links:y,image:u};if(r.video){u.video=r.video;s="full";j=true;u.video=r.video}else if(r.map&&r.map.latlong){m=true;s="full"}else if(r.description.length>1200||f.dimensions.container.width<500)s="full";switch(s){case "full":s=a.tmpl(f._templates.event_modal_full,u);u=32;s.appendTo(g).position({my:"left top",at:"left top",of:g,collision:"none none"});u=f.dimensions.container.height;var z=f.dimensions.container.width;y=s.find(".tg-full_modal_panel");s=z-64;u-=64;p=0;y.css({width:s,height:u,top:"32px",
left:"32px"});y=a(".tg-full_modal-body");z=u-120;if(m==true){$map=a("<div id='map_modal_map' class='tg-modal_map'></div>").prependTo(y);p=r.map.zoom||12;m=String(r.map.latlong).split(",");m=new google.maps.LatLng(parseFloat(m[0]),parseFloat(m[1]));p={zoom:p,center:m,mapTypeId:google.maps.MapTypeId.ROADMAP};p=new google.maps.Map(a("#map_modal_map")[0],p);if(r.map.markers)for(m=0;m<r.map.markers.length;m++){j=r.map.markers[m];new google.maps.MarkerImage(j.image,new google.maps.Size(24,32),new google.maps.Point(0,
0),new google.maps.Point(0,32));var C=j.latlong.split(",");C=new google.maps.LatLng(C[0],C[1]);j=new google.maps.Marker({position:C,map:p,icon:j.icon,title:j.title,zIndex:j.zIndex})}}else if(j==true){$vid=a("<div class='tg-modal-video'><iframe frameborder='0' src='"+r.video+"'></iframe></div>").prependTo(".tg-full_modal-body");$vid.find("iframe").css("height",$vid.width()*0.66)}if(r.image){m=a(".tg-full_modal-body img");j=u-110;if(r.image.height>j)m.css("height",j);else if(r.image.width<s/3){p=r.image.width;
m.css("width",p)}}y.height()>z-16&&y.css({height:z-16,"overflow-y":"scroll"});break;case "link-iframe":s=a.tmpl(f._templates.event_modal_iframe,u);s.appendTo(l).css("z-index",f.ztop++).position({my:"center top+32",at:"center top",of:a(g),collision:"flip fit"}).hover(function(){a(this).css("z-index",f.ztop++)});break;case "custom":break;default:u.extra_class=u.image?"has-image":"no-image";s=a.tmpl(f._templates.event_modal_small,u).appendTo(e.parent());u=8;r=e.position().left;j=e.position().top;y=e.offset();
C=f.dimensions.container.height;z=f.dimensions.container.offset;p=s.outerHeight();m=s.outerWidth();var D,F=C=C-Math.abs(j)-60,B=D=Math.abs(j);if(v.inverted){B=C;F=D}top_set=B>p?j+e.height()+8:F>p?j-(p+12):j-p/2;j=y.left-z.left;m=f.dimensions.container.width-(m+u);if(j<u)r+=Math.abs(j)+u;else if(j>m)r-=j-m;s.css({"z-index":f.ztop++,top:top_set,left:r})}a.fn.jScrollPane&&a(".jscroll").jScrollPane()},legendModal:function(b){var e=h.timelineCollection.get(b).attributes.legend,f="",m="";m=v.legend.type===
"checkboxes"?"tg-legend-item tg-legend-icon-selected":"tg-legend-item";_.each(e,function(j){f+="<li class='"+m+"'><img class='tg-legend-icon' src='"+v.icon_folder+j.icon+"'><span class='legend-info'>"+j.title+"</span></li>"});b={id:b,legend_list:f};a(g+" .tg-legend").remove();a.tmpl(this._templates.legend_modal,b).appendTo(g).css("z-index",this.ztop++).toggleClass("tg-display-none").position({my:"right-64 top+38",at:"right top",of:a(g),collision:"none"});a(g).delegate(".tg-legend-item","mouseup",
function(){var j=a(this);debug.log("leg item:",j);var p=j.children("img").attr("src");j.toggleClass("tg-legend-icon-selected");h.setFilters({origin:"legend",icon:p})});v.legend.type==="checkboxes"&&setTimeout(function(){a(".tg-legend-all").trigger("click")},200)},parseHTMLTable:function(b){var e={},f=+new Date,m=[];a("#"+b).find("tr").each(function(j){var p=a(this).children(),s;if(j===0)m=p.map(function(){return a(this).attr("class").replace(/^.*?\btg-(\S+)\b.*?$/,"$1")}).get();else{s={};p.each(function(r){s[m[r]]=
a(this).text()});e["prefix"+f++]=s}});return e}};t.TG_TimelineView=Backbone.View.extend({initialize:function(b){var e=this;this.mediator=b.model.get("mediator");this.model.bind("change:title",function(){a(e.el).find(".timeline-title-span").text(e.model.get("title"))});this.titleBar=this.mediator.timelineCollection.length>1||t.mode=="authoring"?"fullBar":"hiddenBar";this.model.bind("destroy",this.remove,this)},tagName:"div",events:{"click .timeline-title-span":"titleClick"},className:"tg-timeline-envelope",
getTemplate:function(){var b="",e="";b=e="";b=this.model.get("inverted")?" timeline-inverted":"";if(this.titleBar=="fullBar"){b="<div class='titleBar'><div class='timeline-title"+b+"'><span class='timeline-title-span'>";e="<div class='tg-env-buttons'>";if(this.model.get("description"))e+="<div class='tg-env-button tg-env-info timeline-info-bt' data-timeline_id='${id}'></div>";if(this.model.get("hasLegend"))e+="<div class='tg-env-button tg-env-legend tg-legend-bt' data-timeline_id='${id}'></div>";
e+="<div class='tg-env-button tg-env-invert tg-invert-bt' data-timeline_id='${id}'></div>";e+="<div class='tg-env-button tg-env-expcol tg-expcol-bt' data-timeline_id='${id}'></div>";e+="</div>";e=timeglider.mode=="preview"||timeglider.mode=="publish"?e:"";b+=e+"${title}</span></div></div>"}else b=this.titleBar=="imageBar"?"<div class='titleBar imageBar'></div>":"<div class='titleBar tg-display-none'></div>";return b},render:function(){this.model.get("id");this.model.get("title");var b=this.getTemplate(),
e=this.model.get("inverted")?"inverted":"straight-up";a(this.el).html(a.tmpl(b,this.model.attributes)).attr("id",this.model.get("id")).addClass(e);return this},setText:function(){},titleClick:function(){h.timelineTitleClick(this.model.get("id"))},remove:function(){a(this.el).remove()}});t.zoomTree=[{},{unit:"da",width:35E3,level:1,label:"30 minutes"},{unit:"da",width:17600,level:2,label:"1 hour"},{unit:"da",width:8800,level:3,label:"2 hours"},{unit:"da",width:4400,level:4,label:"5 hours"},{unit:"da",
width:2200,level:5,label:"10 hours"},{unit:"da",width:1100,level:6,label:"1 DAY"},{unit:"da",width:550,level:7,label:"40 hours"},{unit:"da",width:432,level:8,label:"2 days"},{unit:"da",width:343,level:9,label:"2.5 days"},{unit:"da",width:272,level:10,label:"3 days"},{unit:"da",width:216,level:11,label:"4 days"},{unit:"da",width:171,level:12,label:"5 days"},{unit:"da",width:136,level:13,label:"1 WEEK"},{unit:"da",width:108,level:14,label:"8 days"},{unit:"mo",width:2509,level:15,label:"10 days"},{unit:"mo",
width:1945,level:16,label:"2 WEEKS"},{unit:"mo",width:1508,level:17,label:"18 days"},{unit:"mo",width:1169,level:18,label:"3 weeks"},{unit:"mo",width:913,level:19,label:"1 MONTH"},{unit:"mo",width:719,level:20,label:"5 weeks"},{unit:"mo",width:566,level:21,label:"6 weeks"},{unit:"mo",width:453,level:22,label:"2 MONTHS"},{unit:"mo",width:362,level:23,label:"10 weeks"},{unit:"mo",width:290,level:24,label:"3 MONTHS"},{unit:"mo",width:232,level:25,label:"4 months"},{unit:"mo",width:186,level:26,label:"5 months"},
{unit:"mo",width:148,level:27,label:"6 MONTHS"},{unit:"mo",width:119,level:28,label:"7 months"},{unit:"mo",width:95,level:29,label:"9 months"},{unit:"mo",width:76,level:30,label:"1 YEAR"},{unit:"ye",width:723,level:31,label:"15 months"},{unit:"ye",width:573,level:32,label:"18 months"},{unit:"ye",width:455,level:33,label:"2 YEARS"},{unit:"ye",width:361,level:34,label:"2.5 years"},{unit:"ye",width:286,level:35,label:"3 years"},{unit:"ye",width:227,level:36,label:"4 years"},{unit:"ye",width:179,level:37,
label:"5 years"},{unit:"ye",width:142,level:38,label:"6 years"},{unit:"ye",width:113,level:39,label:"8 years"},{unit:"ye",width:89,level:40,label:"10 years"},{unit:"de",width:705,level:41,label:"13 years"},{unit:"de",width:559,level:42,label:"16 years"},{unit:"de",width:443,level:43,label:"20 years"},{unit:"de",width:302,level:44,label:"25 years"},{unit:"de",width:240,level:45,label:"30 years"},{unit:"de",width:190,level:46,label:"40 years"},{unit:"de",width:150,level:47,label:"50 years"},{unit:"de",
width:120,level:48,label:"65 years"},{unit:"de",width:95,level:49,label:"80 years"},{unit:"de",width:76,level:50,label:"100 YEARS"},{unit:"ce",width:600,level:51,label:"130 years"},{unit:"ce",width:480,level:52,label:"160 years"},{unit:"ce",width:381,level:53,label:"200 YEARS"},{unit:"ce",width:302,level:54,label:"250 years"},{unit:"ce",width:240,level:55,label:"300 years"},{unit:"ce",width:190,level:56,label:"400 years"},{unit:"ce",width:150,level:57,label:"500 YEARS"},{unit:"ce",width:120,level:58,
label:"600 years"},{unit:"ce",width:95,level:59,label:"1000 YEARS"},{unit:"ce",width:76,level:60,label:"1100 years"},{unit:"thou",width:603,level:61,label:"1500 years"},{unit:"thou",width:478,level:62,label:"2000 years"},{unit:"thou",width:379,level:63,label:"2500 years"},{unit:"thou",width:301,level:64,label:"3000 years"},{unit:"thou",width:239,level:65,label:"4000 years"},{unit:"thou",width:190,level:66,label:"5000 YEARS"},{unit:"thou",width:150,level:67,label:"6000 years"},{unit:"thou",width:120,
level:68,label:"7500 years"},{unit:"thou",width:95,level:69,label:"10,000 YEARS"},{unit:"thou",width:76,level:70,label:"12,000 years"},{unit:"tenthou",width:603,level:71,label:"15,000 years"},{unit:"tenthou",width:358,level:72,label:"25,000 years"},{unit:"tenthou",width:213,level:73,label:"40,000 years"},{unit:"tenthou",width:126,level:74,label:"70,000 years"},{unit:"tenthou",width:76,level:75,label:"100,000 YEARS"},{unit:"hundredthou",width:603,level:76,label:"150,000 years"},{unit:"hundredthou",
width:358,level:77,label:"250,000 years"},{unit:"hundredthou",width:213,level:78,label:"400,000 years"},{unit:"hundredthou",width:126,level:79,label:"700,000 years"},{unit:"hundredthou",width:76,level:80,label:"1 million years"},{unit:"mill",width:603,level:81,label:"1.5 million years"},{unit:"mill",width:358,level:82,label:"3 million years"},{unit:"mill",width:213,level:83,label:"4 million years"},{unit:"mill",width:126,level:84,label:"6 million years"},{unit:"mill",width:76,level:85,label:"10 million years"},
{unit:"tenmill",width:603,level:86,label:"15 million years"},{unit:"tenmill",width:358,level:87,label:"25 million years"},{unit:"tenmill",width:213,level:88,label:"40 million years"},{unit:"tenmill",width:126,level:89,label:"70 million years"},{unit:"tenmill",width:76,level:90,label:"100 million years"},{unit:"hundredmill",width:603,level:91,label:"120 million years"},{unit:"hundredmill",width:358,level:92,label:"200 million years"},{unit:"hundredmill",width:213,level:93,label:"300 million years"},
{unit:"hundredmill",width:126,level:94,label:"500 million years"},{unit:"hundredmill",width:76,level:95,label:"1 billion years"},{unit:"bill",width:603,level:96,label:"15 million years"},{unit:"bill",width:358,level:97,label:"30 million years"},{unit:"bill",width:213,level:98,label:"50 million years"},{unit:"bill",width:126,level:99,label:"80 million years"},{unit:"bill",width:76,level:100,label:"100 billion years"}];t.calculateSecPerPx=function(b){for(var e=1;e<b.length;e++){var f=b[e],m=0;switch(f.unit){case "da":m=
86400;break;case "mo":m=2419200;break;case "ye":m=31536E3;break;case "de":m=31536E4;break;case "ce":m=31536E5;break;case "thou":m=31536E6;break;case "tenthou":m=31536E7;break;case "hundredthou":m=31536E8;break;case "mill":m=31536E9;break;case "tenmill":m=31536E10;break;case "hundredmill":m=31536E11;break;case "bill":m=31536E12}f.spp=Math.round(m/parseInt(f.width))}}(t.zoomTree);t.getStringWidth=function(b){var e=a("#timeglider-measure-span");e.css("font-size",h.base_font_size);return b?e.html(b).width()+
h.base_font_size:false};t.scaleToImportance=function(b,e){return((b-e)*4.5+100)/100};String.prototype.removeWhitespace=function(){return this.replace(RegExp("\\n","g"),"")};if(debug)debug.trace=function(b,e){a("#"+e).text(b)};t.googleMapsInit=function(){};t.googleMapsLoaded=false;t.googleMapsLoad=function(){if(t.googleMapsLoaded==false){var b=document.createElement("script");b.type="text/javascript";b.src="http://maps.googleapis.com/maps/api/js?sensor=false&callback=timeglider.googleMapsInit";document.body.appendChild(b);
t.googleMapsLoaded=true}}})(timeglider);(function(t){var A={},x=t.TG_Date,h={},v=jQuery,w={},n="";t.TG_Mediator=function(d,i){this.options=h=d;w=i;n=d.base_namespace+"#"+w.attr("id");this.viewMode="timeline";this._focusDate={};this._zoomInfo={};this._zoomLevel=0;this.ticksReady=false;this.ticksArray=[];this.startSec=0;this.activeTimelines=[];this.max_zoom=h.max_zoom;this.min_zoom=h.min_zoom;this.icon_folder=t.icon_folder=h.icon_folder||"js/timeglider/icons/";this.timeOffset=x.getTimeOffset(h.timezone);this.base_font_size=14;this.fixed_zoom=
this.max_zoom==this.min_zoom?true:false;this.gesturing=false;this.gestureStartScale=this.gestureStartZoom=0;this.filters={include:"",exclude:"",legend:[],tags:[]};this.filterActions={};this.loadedSources=[];this.timelineCollection=new Backbone.Collection;this.eventCollection=new t.TG_EventCollection;this.imagesToSize=this.imagesSized=0;this.timelineDataLoaded=false;this.image_lane_height=0;this.initial_timelines=[];this.initial_timeline_id=h.initial_timeline_id||"";this.sole_timeline_id="";this.dimensions=
{};this.focusedEvent="";this.scopeChanges=this.singleTimelineID=0;this.initialScope={};this.scopeCache={};if(h.max_zoom===h.min_zoom)this.fixed_zoom=h.min_zoom;if(h.main_map){this.main_map=h.main_map;timeglider.mapping.setMap(this.main_map,this)}A=this};t.TG_Mediator.prototype={emptyData:function(){this.eventCollection.reset();this.timelineCollection.reset();this.eventCollection=new t.TG_EventCollection;this.timelineCollection=new Backbone.Collection;this.activeTimelines=[]},focusToEvent:function(d,
i){this.focusedEvent=d;this.gotoDateZoom(d.startdateObj.dateStr);v.publish(n+".mediator.focusToEvent");typeof i=="function"&&i(d)},filterBy:function(d,i){var a={origin:d};a[d]=i;this.setFilters(a)},setImageLaneHeight:function(d,i,a){this.image_lane_height=d;a&&v.publish(n+".mediator.imageLaneHeightSetUi");i&&this.refresh()},setInitialScope:function(){this.initialScope=this.scopeCache;v.publish(n+".mediator.initialScope")},getInitialScope:function(){return this.initialScope},gotoDateZoom:function(d,
i){var a=false;this.setFocusDate(new x(d));if(i)a=this.setZoomLevel(i);if(!i||a==false)this.refresh();v.publish(n+".mediator.scopeChange")},zoom:function(d){this.setZoomLevel(this.getZoomLevel()+parseInt(d))},focusTimeline:function(d){var i=this.timelineCollection.get(d);d=i.get("focus_date");i=i.get("initial_zoom");this.gotoDateZoom(d,i)},loadPresentation:function(d){var i=this,a=d.timelines,k="",c=[],g=0,l=0,o="expanded",q={};if(d.timelines.length>0){_.each(a,function(b){if(b.open==1){k=b.timeline_id;
c.push(k);l=b.bottom||30;o=b.display||"expanded";g=b.inverted||0;q=i.timelineCollection.get(k);q.set({inverted:g,display:o,bottom:l})}});i.setFocusDate(new t.TG_Date(d.focus_date));i.activeTimelines=c;i.setZoomLevel(d.initial_zoom);i.setImageLaneHeight(d.image_lane_height||0,false,true);i.refresh()}else{alert("There are no timelines in this presentation...");return false}},reloadTimeline:function(d,i){var a=this.timelineCollection.get(d),k=this.eventCollection,c=this.eventCollection.getTimelineHash(d).all;
_.each(c,function(g){k.remove(g)});this.timelineCollection.remove(a);this.eventCollection.setTimelineHash(d,{});this.loadTimelineData(i,{fn:function(){alert("reloaded")},toggle:true},true)},drilldown:function(){},getScope:function(){var d=this.getZoomInfo(),i=this.getFocusDate(),a=this.getActiveTimelinesBounds();i=Math.round(i.sec);var k=t.TG_Date.TGSecToUnixSec(i),c=this.dimensions.container.width,g=c/2;d=Math.round(d.spp);return this.scopeCache=a={spp:d,width:c,focusDateSec:i,timelines:this.activeTimelines,
timelineBounds:a,container:w,left_sec:i-g*d,right_sec:i+g*d,leftMS:(k-g*d)*1E3,rightMS:(k+g*d)*1E3,focusMS:k*1E3}},fitToContainer:function(){var d=this.getActiveTimelinesBounds(),i=d.last-d.first;d=(d.first+d.last)/2;var a=this.dimensions.container.width,k=_.find(t.zoomTree,function(c){return i/c.spp<a});this.gotoDateZoom(d,k.level)},resize:function(){v.publish(n+".mediator.resize")},addFilterAction:function(d,i,a){this.filterActions[d]={filter:i,fn:a};this.refresh()},removeFilterAction:function(d){delete this.filterActions[d];
this.refresh()},getEventByID:function(d,i){var a=this.eventCollection.get(d).attributes;return i&&a.hasOwnProperty(i)?a[i]:a},getPastEvents:function(d,i){var a=this,k=this.getScope(),c=false;return k.timelineBounds.first<k.focusDateSec?_.filter(this.eventCollection.models,function(g){if(i){if(g.get("startdateObj").sec<k.left_sec)c=true}else c=true;var l=d?a.isEventVisible(g):true,o=_.intersection(a.activeTimelines,g.get("timelines"));return c&&o.length>0&&l&&g.get("startdateObj").sec<k.focusDateSec}):
false},gotoPreviousEvent:function(){if(this.activeTimelines.length==0){alert("No timelines are loaded.");return false}var d=this.getPastEvents(true,false);if(d.length>0)this.focusToEvent(_.last(d).attributes,function(i){v(".timeglider-timeline-event").removeClass("tg-event-selected");v(".timeglider-timeline-event#"+i.id).addClass("tg-event-selected")});else{alert("There are no events prior to this point");return false}},getFutureEvents:function(d,i){var a=this,k=this.getScope(),c=false;return k.timelineBounds.last>
k.focusDateSec?_.filter(this.eventCollection.models,function(g){if(i){if(g.get("startdateObj").sec>k.right_sec)c=true}else c=true;var l=d?a.isEventVisible(g):true,o=_.intersection(a.activeTimelines,g.get("timelines"));return c&&o.length>0&&l&&g.get("startdateObj").sec>k.focusDateSec}):false},gotoNextEvent:function(){if(this.activeTimelines.length==0){alert("No timelines are loaded.");return false}var d=this.getFutureEvents(true,false);if(d.length>0)this.focusToEvent(_.first(d).attributes,function(i){v(".timeglider-timeline-event").removeClass("tg-event-selected");
v(".timeglider-timeline-event#"+i.id).addClass("tg-event-selected")});else{alert("There are no events farther ahead of this point.");return false}},isEventVisible:function(d){var i=this._zoomLevel;return i<=d.get("high_threshold")&&i>=d.get("low_threshold")?true:false},adjustNowEvents:function(){var d=false,i="",a="";_.each(this.eventCollection.models,function(k){if(k.get("keepCurrent")){i=k.get("keepCurrent");a=k.get("date_display");if(i=="start")k.set({startdateObj:new x("today",a)});else i=="end"&&
k.set({enddateObj:new x("today",a)});k.reIndex();d=true}});d&&this.refresh()},addEvent:function(d,i){i=i||false;d.startdateObj=new t.TG_Date(d.startdate);d.enddateObj=new t.TG_Date(d.enddate||d.startdate);d.mediator=this;d.cache={timelines:d.timelines,startdateObj:d.startdateObj,enddateObj:d.enddateObj,span:true};var a=new t.TG_Event(d);this.eventCollection.add(a);a.reIndex();i&&this.refresh();v.publish(n+".mediator.addEvent");return a},updateEvent:function(d){if(!d.id){alert("error: you need a valid id set on the object in updateEvent()");
return false}var i=this.eventCollection.get(d.id);i.set(d);if(d.startdateObject||d.enddateObject)i.reIndex();this.refresh();v.publish(n+".mediator.updateEvent");return i},getActiveTimelinesBounds:function(){for(var d=this.activeTimelines,i={},a=99999999999,k=0,c=0;c<d.length;c++){i=this.timelineCollection.get(d[c]);a=i.get("bounds").first<a?i.get("bounds").first:a;k=i.get("bounds").last>k?i.get("bounds").last:k}return{first:a,last:k}},removeFromActive:function(d){d=_.indexOf(this.activeTimelines,
d);if(d!=-1){this.activeTimelines.splice(d,1);return true}else return false},loadTimelineData:function(d,i,a){a=a||false;var k=this;if(d){if(_.indexOf(k.loadedSources,d)==-1||a==true){if(typeof d==="object")k.parseTimelineData(d,i);else if(d.substr(0,1)=="#"){a=[k.getTableTimelineData(d)];k.parseTimelineData(a)}else v.ajax({url:d,type:"GET",cache:false,dataType:"json",error:function(c,g,l){debug.log("loadTimelineData json error:",JSON.stringify(c),JSON.stringify(g),l)},success:function(c){if(c.error){c.password_required==
1?alert("This presentation requires a password. Here at Timeglider, we're rebuilding our presentation system. Come back soon!"):alert(c.error);return false}else k.parseTimelineData(c,i)}});k.loadedSources.push(d)}}else{this.timelineDataLoaded=true;this.setZoomLevel(Math.floor((this.max_zoom+this.min_zoom)/2));this.tryLoading()}},mapMarkerClick:function(d){this.focusToEvent(d)},getTimelineCollection:function(){return this.timelineCollection},timelineTitleClick:function(d){v.publish(n+".mediator.timelineTitleClick",
{timeline_id:d})},getTableTimelineData:function(d){var i={},a=0,k=[],c,g,l="",o=v(d);i.id=d.substr(1);i.title=o.attr("title")||"untitled";i.description=o.attr("description")||"";i.focus_date=o.attr("focus_date")||x.getToday();i.initial_zoom=o.attr("initial_zoom")||20;i.events=[];o.find("tr").each(function(q){var b=v(this).children(),e;if(q===0)k=b.map(function(){return v(this).attr("class").replace(/^.*?\btg-(\S+)\b.*?$/,"$1")}).get();else{e={};b.each(function(f){c=k[f];g=c=="description"?v(this).html():
v(this).text();e[c]=g});l="ev_"+a++;e.id=l;i.events.push(e)}});o.css("display","none");return i},runLoadedTimelineCallback:function(d,i){d.fn(d.args||"",i);if(d.display)this.showSingleTimeline(i[0].id);else if(d.toggle){this.activeTimelines=[i[0].id];this.refresh()}},parseTimelineData:function(d,i){debug.log("parse data",i);var a="";if(typeof d.presentation=="string"){timeglider.mode="presentation";a=d.timelines;this.initial_timelines=d.initial_timelines;this.presentation={title:d.title,description:d.description,
open_modal:d.open_modal,focus_date:new t.TG_Date(d.focus_date),initial_zoom:d.initial_zoom}}else a=d;var k=this,c=0,g=a.length,l={};l={};for(var o=0;o<g;o++){l=a[o];l.mediator=k;l=(new t.TG_Timeline(l)).toJSON();if(l.id.length>0){c++;k.swallowTimeline(l)}}if(i&&(typeof i.fn=="function"||typeof i=="function")){if(typeof i=="function")i={fn:i};setTimeout(function(){k.runLoadedTimelineCallback(i,a,k)},100);if(i.display||i.toggle)return false}if(c===0)alert("ERROR loading data: Check JSON with jsonLint");
else{c=false;if(i.display==true||typeof i.display=="undefined")c=true;this.timelineDataLoaded=true;if(c||i.toggle){debug.log("try loading..>!");this.tryLoading()}}},tryLoading:function(){var d=this.timelineDataLoaded==true;if(this.imagesSized==this.imagesToSize&&d){this.setInitialTimelines();if(this.timelineCollection.length==1){tl=A.timelineCollection.at(0);this.singleTimelineID=tl.get("id");this.setImageLaneHeight(tl.get("image_lane_height")||0,false,true)}v.publish(n+".mediator.timelineDataLoaded")}},
swallowTimeline:function(d){this.sole_timeline_id=d.id;var i=this.timelineCollection.get(d.id);i?i.set(d):this.timelineCollection.add(d)},setInitialTimelines:function(){var d=this;if(d.initial_timelines.length>0)d.activeTimelines=d.initial_timelines;else{var i=d.initial_timeline_id,a="";if(typeof i=="object"){a=this.initial_timeline_id[0];_.each(i,function(k){d.activeTimelines.push(k)})}else if(i.length>0){a=this.initial_timeline_id||this.sole_timeline_id;d.activeTimelines=[a]}else if(this.timelineCollection.length>
0){a=this.timelineCollection.pluck("id")[0];d.activeTimelines=[a]}}if(timeglider.mode!="presentation")if(timeglider.mode=="authoring")d.setZoomLevel(40);else a?setTimeout(function(){var k=d.timelineCollection.get(a),c=k.get("focusDateObj");d.setFocusDate(c);d.setZoomLevel(k.get("initial_zoom"))},500):d.setZoomLevel(40)},refresh:function(){v.publish(n+".mediator.refreshSignal")},setTicksReady:function(d){this.ticksReady=d;this.startSec=this._focusDate.sec;d===true&&v.publish(n+".mediator.ticksReadySignal")},
setTimeoffset:function(d){this.timeOffset=x.getTimeOffset(d);this.refresh()},getTimeoffset:function(){return this.timeOffset},setDimensions:function(d){this.dimensions=d},setFocusDate:function(d){if(d!=this._focusDate)this._focusDate=d},getFocusDate:function(){return this._focusDate},getZoomLevel:function(){return parseInt(this._zoomLevel)},mousewheelChange:function(d){var i=this.options.mousewheel;if(i==="zoom")this.viewMode=="timeline"&&this.setZoomLevel(this.getZoomLevel()+d);else i==="pan"&&v.publish(n+
".mediator.mousewheelChange",{dir:d,action:"pan"})},setZoomLevel:function(d){if(d<1)d=1;if(d==1||d<=this.max_zoom&&d>=this.min_zoom){this.startSec=this._focusDate.sec;if(d!=this._zoomLevel){this._zoomLevel=d;this._zoomInfo=t.zoomTree[d];v.publish(n+".mediator.zoomLevelChange");v.publish(n+".mediator.scopeChange");return true}else return false}else return false},getZoomInfo:function(){return this._zoomInfo},getDateFromOffset:function(d){var i=this.dimensions.container;d=d-i.offset.left-i.width/2;i=
this.getZoomInfo().spp;var a=this.getFocusDate().sec;return new x(Math.floor(a+-1*this.timeOffset.seconds+d*i))},registerUIEvent:function(d){switch(d.name){case "dblclick":case "dbltap":var i=this.getDateFromOffset(d.event.pageX);v.publish(n+".mediator.dblclick",{date:i,event:d.event})}},setFilters:function(d,i){switch(d.origin){case "clude":this.filters.include=d.include;this.filters.exclude=d.exclude;break;case "title_andor_desc":this.filters.description=d.description;this.filters.title=d.title;
this.filters.tags=d.tags?d.tags.split(","):[];break;case "tags":this.filters.tags=d.tags?d.tags.split(","):[];break;case "legend":var a=d.icon.replace(this.options.icon_folder,"");if(a=="all"){this.filters.legend=[];v.publish(n+".mediator.legendAll")}else if(a=="none"){this.filters.legend=["_none_.png"];v.publish(n+".mediator.legendAll")}else if(a=="provided")this.filters.legend=i;else if(_.indexOf(this.filters.legend,a)==-1)this.filters.legend.push(a);else{var k=[];k=v.grep(this.filters.legend,function(c){return c!=
a});this.filters.legend=k}break;case "custom":if(d.action=="add")this.filters.custom=d.fn;else delete this.filters.custom}v.publish(n+".mediator.filtersChange");this.refresh()},clearFilters:function(d){clear_legend=d.legend||false;clear_custom=d.custom||false;this.filters.exclude="";this.filters.include="";this.filters.title="";this.filters.description="";if(clear_legend)this.filters.legend=[];if(clear_custom)this.filters.custom=""},getTicksOffset:function(){return this._ticksOffset},setTicksOffset:function(d){this._ticksOffset=
d;v.publish(n+".mediator.ticksOffsetChange");v.publish(n+".mediator.scopeChange")},getTickBySerial:function(d){for(var i=this.ticksArray,a=i.length,k=0;k<a;k++){var c=i[k];if(c.serial==d)return c}return false},addToTicksArray:function(d,i){if(d.type=="init"){d.serial=x.getTimeUnitSerial(i,d.unit);this.ticksArray=[d]}else if(d.type=="l"){d.serial=this.ticksArray[0].serial-1;this.ticksArray.unshift(d)}else{d.serial=this.ticksArray[this.ticksArray.length-1].serial+1;this.ticksArray.push(d)}v.publish(n+
".mediator.ticksArrayChange");return d.serial},showSingleTimeline:function(d){this.activeTimelines=[];this.toggleTimeline(d)},toggleTimeline:function(d){var i=this.timelineCollection.get(d).attributes,a=false,k=_.indexOf(this.activeTimelines,d);if(k==-1){this.activeTimelines.push(d);this.setFocusDate(new x(i.focus_date));this.setZoomLevel(i.initial_zoom);if(i.initial_zoom==this.getZoomLevel())a=true}else{this.activeTimelines.splice(k,1);a=true}a&&this.refresh();v.publish(n+".mediator.activeTimelinesChange")},
reportImageSize:function(d){var i=A.eventCollection.get(d.id);if(i.has("image")){if(d.error){i.attributes.image={};debug.log("WHOOPS: MISSING IMAGE: "+d.src)}else{i.attributes.image.width=d.width;i.attributes.image.height=d.height}this.imagesSized++;this.imagesSized==this.imagesToSize&&this.tryLoading()}}};t.getLowHigh=function(d){d=_.sortBy(d,function(i){return parseInt(i)});return{low:_.first(d),high:_.last(d)}};t.validateOptions=function(d){this.optionsMaster={initial_focus:{type:"date"},timezone:{type:"timezone"},
editor:{type:"string"},backgroundColor:{type:"color"},backgroundImage:{type:"color"},min_zoom:{type:"number",min:1,max:100},max_zoom:{type:"number",min:1,max:100},initial_zoom:{type:"number",min:1,max:100},show_centerline:{type:"boolean"},display_single_timeline_info:{type:"boolean"},minimum_timeline_bottom:{type:"number",min:0,max:1E3},display_zoom_level:{type:"boolean"},data_source:{type:"url"},basic_fontsize:{type:"number",min:9,max:100},mousewheel:{type:"string",possible:["zoom","pan","none"]},
initial_timeline_id:{type:"mixed"},icon_folder:{type:"string"},show_footer:{type:"boolean"},display_zoom_level:{type:"boolean"},constrain_to_data:{type:"boolean"},boost:{type:"number",min:0,max:99},event_modal:{type:"object"},event_overflow:{type:"string"}};var i=this,a="";v.each(d,function(k,c){if(i.optionsMaster[k])switch(i.optionsMaster[k].type){case "string":if(typeof c!="string")a+=k+" needs to be a string.\n";if(i.optionsMaster[k].possible)if(_.indexOf(i.optionsMaster[k].possible,c)==-1)a+=
k+" must be: "+i.optionsMaster[k].possible.join(" or ");break;case "number":if(typeof c!="number")a+=c+" needs to be a number.\n";if(i.optionsMaster[k].min)if(c<i.optionsMaster[k].min)a+=k+" must be greater than or equal to "+i.optionsMaster[k].min+"\n";if(i.optionsMaster[k].max)if(c>i.optionsMaster[k].max)a+=k+" must be less than or equal to "+i.optionsMaster[k].max+"\n";break;case "timezone":var g=/[+|-]?[0-9]+:[0-9]+/;if(_.indexOf(["New York","Denver","Chicago","Los Angeles"],c)==-1&&c.match(g)==
-1)a+="The timezone is not formatted properly";break;case "boolean":if(typeof c!="boolean")a+=c+" needs to be a number.\n"}});return a}})(timeglider);(function(t){var A,x=timeglider,h,v=timeglider.TG_Date;t.widget("timeglider.timeline",{options:{base_namespace:"tg",timezone:"00:00",initial_focus:x.TG_Date.getToday(),editor:"none",min_zoom:1,max_zoom:100,show_centerline:true,data_source:"",culture:"en",base_font_size:16,mousewheel:"zoom",initial_timeline_id:"",icon_folder:"js/timeglider/icons/",image_lane_height:32,show_footer:true,minimum_timeline_bottom:24,display_zoom_level:false,display_single_timeline_info:true,initial_timeline_modal:true,
constrain_to_data:true,boost:0,tick_top:"",event_modal:{type:"default"},event_overflow:"plus",legend:{type:"default"}},_create:function(){this._id=t(this.element).attr("id");this.element.html("<div id='tg-container' class='timeglider-container'><div class='timeglider-loading'><div>loading</div></div><div class='timeglider-centerline'></div><div class='tg-oof-count tg-oof-left'></div><div class='tg-oof-count tg-oof-right'></div><div class='timeglider-truck' id='tg-truck'><div class='timeglider-ticks noselect'><div class='timeglider-handle'></div></div></div><div class='timeglider-slider-container noselect'>\t<div class='tg-slider-plusminus tg-slider-plus tg-zoom-in'></div>\t<div class='timeglider-slider'></div>\t<div class='tg-slider-plusminus tg-slider-minus tg-zoom-out'></div>\t<div class='timeglider-pan-buttons'>\t<div class='timeglider-pan-left'></div><div class='timeglider-pan-right'></div></div></div><div class='tg-scrim'></div><div class='timeglider-footer' id='tg-footer'><div class='timeglider-logo'></div><div class='tg-footer-center'><div class='tg-prev tg-prevnext'><a>prev</a></div><div class='tg-date-display noselect'><div class='tg-date-display-arrow'></div><span></span></div><div class='tg-next tg-prevnext'><a>next</a></div></div>\t<div class='tg-footer-buttons'>\t<div class='timeglider-footer-button timeglider-filter-bt'></div>\t<div class='timeglider-footer-button timeglider-settings-bt'></div></div></div><div class='timeglider-event-hover-info'></div></div><span id='timeglider-measure-span'></span>")},
_init:function(){var w=timeglider.validateOptions(this.options);if(w==""){x.TG_Date.setCulture(this.options.culture);h=new x.TG_Mediator(this.options,this.element);this.player=A=new x.TG_TimelinePlayer(this,h);h.setFocusDate(new v(this.options.initial_focus));h.loadTimelineData(this.options.data_source,this.options.loaded)}else alert("Rats. There's a problem with your widget settings:"+w);this.element.data("timeline",this.element.data("timegliderTimeline"))},goTo:function(w,n){if(w=="next")h.gotoNextEvent();
else w=="previous"?h.gotoPreviousEvent():h.gotoDateZoom(w,n);return this},refresh:function(){h.refresh();return this},resize:function(){A.resize();return this},filterBy:function(w,n){h.filterBy(w,n);return this},addFilterAction:function(w,n,d){h.addFilterAction(w,n,d);return this},removeFilterAction:function(w){h.removeFilterAction(w);return this},getMediator:function(){return h},getEventByID:function(w,n){return h.getEventByID(w,n)},updateEvent:function(w){return h.updateEvent(w)},focusToEvent:function(w){w=
h.getEventByID(w);h.focusToEvent(w);return this},getScope:function(){return h.getScope()},fitToContainer:function(){h.fitToContainer();return this},adjustNowEvents:function(){return h.adjustNowEvents()},addEvent:function(w,n){return h.addEvent(w,n)},zoom:function(w){switch(w){case "in":w=-1;break;case "out":w=1}if(w>99||w<-99)return false;h.zoom(w);return this},loadTimeline:function(w,n,d){h.loadTimelineData(w,n,d);return this},reloadTimeline:function(w,n){h.reloadTimeline(w,n);return this},panButton:function(w,
n){var d=0;switch(n){case "left":d=30;break;case "right":d=-30;break;default:d=n}A.setPanButton(w,d)},destroy:function(){h.emptyData();t.Widget.prototype.destroy.apply(this,arguments);t(this.element).html("")}})})(jQuery);
